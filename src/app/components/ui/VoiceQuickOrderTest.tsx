// // // // // "use client";

// // // // // import { useState, useRef, useEffect } from "react";
// // // // // import { Bot, Mic, Send } from "lucide-react";
// // // // // import { motion } from "framer-motion";

// // // // // // ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu
// // // // // interface OrderInfo {
// // // // //   product: string;
// // // // //   quantity: number;
// // // // //   size: string;
// // // // //   address: string;
// // // // // }

// // // // // interface OrderResult {
// // // // //   message: string;
// // // // //   payment_url?: string;
// // // // // }

// // // // // type Step = "idle" | "listening" | "parsing" | "confirming" | "done";

// // // // // export default function VoiceQuickOrderFlexible() {
// // // // //   const [voiceText, setVoiceText] = useState<string>("");
// // // // //   const [orderInfo, setOrderInfo] = useState<OrderInfo | null>(null);
// // // // //   const [orderResult, setOrderResult] = useState<OrderResult | null>(null);
// // // // //   const [step, setStep] = useState<Step>("idle");
// // // // //   const [paymentMethod, setPaymentMethod] = useState<1 | 2>(1);
// // // // //   const recognitionRef = useRef<SpeechRecognition | null>(null);
// // // // //   const [showWidget, setShowWidget] = useState<boolean>(false);
// // // // //   const [aiSpeechText, setAiSpeechText] = useState<string>(""); // üëà subtitle AI n√≥i

// // // // //   useEffect(() => {
// // // // //     if (showWidget && step === "idle") {
// // // // //       speak("Xin ch√†o! B·∫°n mu·ªën ƒë·∫∑t m√≥n g√¨ h√¥m nay?");
// // // // //     }
// // // // //   }, [showWidget, step]);

// // // // //   const speak = (text: string, callback?: () => void) => {
// // // // //     if ("speechSynthesis" in window) {
// // // // //       const utter = new SpeechSynthesisUtterance(text);
// // // // //       utter.lang = "vi-VN";
// // // // //       setAiSpeechText(text); // üëà subtitle hi·ªÉn th·ªã
// // // // //       utter.onend = () => {
// // // // //         setAiSpeechText(""); // üëà ·∫©n sau khi n√≥i xong
// // // // //         callback && callback();
// // // // //       };
// // // // //       window.speechSynthesis.speak(utter);
// // // // //     }
// // // // //   };

// // // // //   const waitForVoiceConfirm = (): Promise<"yes" | "no"> => {
// // // // //     return new Promise((resolve) => {
// // // // //       const recognition = new (window as any).webkitSpeechRecognition();
// // // // //       recognition.lang = "vi-VN";
// // // // //       recognition.start();

// // // // //       recognition.onresult = (event: SpeechRecognitionEvent) => {
// // // // //         const response = event.results[0][0].transcript.toLowerCase();
// // // // //         if (response.includes("ƒë·ªìng √Ω") || response.includes("ok")) {
// // // // //           resolve("yes");
// // // // //         } else {
// // // // //           resolve("no");
// // // // //         }
// // // // //       };

// // // // //       recognition.onerror = () => resolve("no");
// // // // //     });
// // // // //   };

// // // // //   const waitForVoicePaymentMethod = (): Promise<1 | 2> => {
// // // // //     return new Promise((resolve) => {
// // // // //       const recognition = new (window as any).webkitSpeechRecognition();
// // // // //       recognition.lang = "vi-VN";
// // // // //       recognition.start();

// // // // //       recognition.onresult = (event: SpeechRecognitionEvent) => {
// // // // //         const response = event.results[0][0].transcript.toLowerCase();
// // // // //         if (response.includes("ti·ªÅn m·∫∑t")) {
// // // // //           resolve(1);
// // // // //         } else if (response.includes("chuy·ªÉn kho·∫£n")) {
// // // // //           resolve(2);
// // // // //         } else {
// // // // //           resolve(1);
// // // // //         }
// // // // //       };

// // // // //       recognition.onerror = () => resolve(1);
// // // // //     });
// // // // //   };

// // // // //   const startVoice = () => {
// // // // //     if (!("webkitSpeechRecognition" in window)) {
// // // // //       alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ voice!");
// // // // //       return;
// // // // //     }

// // // // //     setStep("listening");
// // // // //     const recognition = new (window as any).webkitSpeechRecognition();
// // // // //     recognition.lang = "vi-VN";

// // // // //     recognition.onresult = (event: SpeechRecognitionEvent) => {
// // // // //       const text = event.results[0][0].transcript;
// // // // //       setVoiceText(text);
// // // // //       parseOrder(text);
// // // // //     };

// // // // //     recognition.start();
// // // // //     recognitionRef.current = recognition;
// // // // //   };

// // // // //   const parseOrder = async (text: string) => {
// // // // //     setStep("parsing");
// // // // //     const token = localStorage.getItem("token");

// // // // //     const res = await fetch("http://localhost:8000/api/voice-order/parse", {
// // // // //       method: "POST",
// // // // //       headers: {
// // // // //         "Content-Type": "application/json",
// // // // //         Authorization: `Bearer ${token}`,
// // // // //       },
// // // // //       body: JSON.stringify({ text }),
// // // // //     });

// // // // //     const data: OrderInfo = await res.json();
// // // // //     setOrderInfo(data);
// // // // //     setStep("confirming");

// // // // //     const confirmText = `B·∫°n mu·ªën mua ${data.quantity} ${data.product} size ${data.size}, giao v·ªÅ ${data.address}. N√≥i "ƒê·ªìng √Ω" ƒë·ªÉ x√°c nh·∫≠n, ho·∫∑c "kh√¥ng" ƒë·ªÉ h·ªßy.`;

// // // // //     speak(confirmText, async () => {
// // // // //       const result = await waitForVoiceConfirm();
// // // // //       if (result === "yes") {
// // // // //         speak(
// // // // //           'Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n: "thanh to√°n b·∫±ng ti·ªÅn m·∫∑t" ho·∫∑c "chuy·ªÉn kho·∫£n".',
// // // // //           async () => {
// // // // //             const method = await waitForVoicePaymentMethod();
// // // // //             setPaymentMethod(method);
// // // // //             speak("X√°c nh·∫≠n ƒë·∫∑t h√†ng...");
// // // // //             await handleQuickOrder(data, method);
// // // // //           }
// // // // //         );
// // // // //       } else {
// // // // //         speak("ƒê√£ hu·ª∑ ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
// // // // //         setOrderInfo(null);
// // // // //         setStep("idle");
// // // // //       }
// // // // //     });
// // // // //   };

// // // // //   const handleQuickOrder = async (orderData: OrderInfo, method: 1 | 2) => {
// // // // //     const token = localStorage.getItem("token");
// // // // //     const payload = {
// // // // //       ...orderData,
// // // // //       payment_id: method,
// // // // //     };

// // // // //     const res = await fetch("http://localhost:8000/api/voice-order/quick", {
// // // // //       method: "POST",
// // // // //       headers: {
// // // // //         "Content-Type": "application/json",
// // // // //         Authorization: `Bearer ${token}`,
// // // // //       },
// // // // //       body: JSON.stringify(payload),
// // // // //     });

// // // // //     const data: OrderResult = await res.json();
// // // // //     setOrderResult(data);
// // // // //     setStep("done");

// // // // //     if (method === 2 && data.payment_url) {
// // // // //       speak("ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPAY...");
// // // // //       window.location.href = data.payment_url;
// // // // //     } else {
// // // // //       speak(data.message || "ƒê·∫∑t h√†ng th√†nh c√¥ng.");
// // // // //     }
// // // // //   };

// // // // //   return (
// // // // //     <motion.div
// // // // //       drag
// // // // //       dragConstraints={{ left: 0, top: 0, right: 500, bottom: 800 }}
// // // // //       className="fixed bottom-20 right-4 z-50"
// // // // //     >
// // // // //       {!showWidget && (
// // // // //         <div className="relative flex flex-col items-center group">
// // // // //           {/* ƒê√°m m√¢y l·ªùi nh·∫Øn ch·ªõp t·ª´ t·ª´ */}
// // // // //           <motion.div
// // // // //             initial={{ opacity: 0 }}
// // // // //             animate={{ opacity: [0, 1, 0] }}
// // // // //             transition={{
// // // // //               duration: 3,
// // // // //               repeat: Infinity,
// // // // //               ease: "easeInOut",
// // // // //             }}
// // // // //             className="mb-3 px-4 py-1 bg-white text-purple-600 text-sm font-semibold rounded-full border border-purple-300 shadow-md backdrop-blur-md"
// // // // //           >
// // // // //             üõí Mua h√†ng nhanh - nh·∫•n tui ƒëi!
// // // // //           </motion.div>

// // // // //           {/* N√∫t tr√≤n AI */}
// // // // //           <motion.button
// // // // //             whileHover={{ scale: 1.08 }}
// // // // //             whileTap={{ scale: 0.95 }}
// // // // //             onClick={() => setShowWidget(true)}
// // // // //             className="rounded-full p-4 bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 text-white shadow-2xl transition-all duration-300"
// // // // //           >
// // // // //             <motion.div
// // // // //               animate={{
// // // // //                 scale: [1, 1.05, 1],
// // // // //                 boxShadow: [
// // // // //                   "0 0 0px rgba(255, 255, 255, 0.6)",
// // // // //                   "0 0 20px rgba(255, 255, 255, 0.9)",
// // // // //                   "0 0 0px rgba(255, 255, 255, 0.6)",
// // // // //                 ],
// // // // //               }}
// // // // //               transition={{
// // // // //                 duration: 4,
// // // // //                 repeat: Infinity,
// // // // //                 ease: "easeInOut",
// // // // //               }}
// // // // //             >
// // // // //               <Bot size={24} />
// // // // //             </motion.div>
// // // // //           </motion.button>
// // // // //         </div>
// // // // //       )}

// // // // //       {showWidget && (
// // // // //         <motion.div
// // // // //           initial={{ opacity: 0, scale: 0.95 }}
// // // // //           animate={{ opacity: 1, scale: 1 }}
// // // // //           exit={{ opacity: 0, scale: 0.95 }}
// // // // //           className="bg-white shadow-2xl rounded-2xl w-80 p-4"
// // // // //         >
// // // // //           <div className="flex justify-between items-center mb-4">
// // // // //             <h3 className="text-lg font-bold">ü§ñ DREAMS</h3>
// // // // //             <button
// // // // //               onClick={() => setShowWidget(false)}
// // // // //               className="text-gray-400 hover:text-gray-600"
// // // // //             >
// // // // //               ‚úï
// // // // //             </button>
// // // // //           </div>

// // // // //           <textarea
// // // // //             className="w-full rounded-md border border-gray-300 p-2 text-sm mb-2"
// // // // //             rows={3}
// // // // //             placeholder="N√≥i ho·∫∑c nh·∫≠p n·ªôi dung ƒë·∫∑t h√†ng..."
// // // // //             value={voiceText}
// // // // //             onChange={(e) => setVoiceText(e.target.value)}
// // // // //           />

// // // // //           <div className="flex gap-2">
// // // // //             <button
// // // // //               onClick={startVoice}
// // // // //               className="flex-1 flex items-center justify-center gap-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600"
// // // // //             >
// // // // //               <Mic size={16} /> N√≥i
// // // // //             </button>
// // // // //             <button
// // // // //               onClick={() => parseOrder(voiceText)}
// // // // //               disabled={!voiceText.trim()}
// // // // //               className="flex-1 flex items-center justify-center gap-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 disabled:opacity-50"
// // // // //             >
// // // // //               <Send size={16} /> G·ª≠i
// // // // //             </button>
// // // // //           </div>

// // // // //           {step === "listening" && (
// // // // //             <p className="text-xs text-blue-500 mt-2">
// // // // //               üéß ƒêang nghe gi·ªçng n√≥i...
// // // // //             </p>
// // // // //           )}
// // // // //           {step === "parsing" && (
// // // // //             <p className="text-xs text-gray-500 mt-2">
// // // // //               üîé ƒêang ph√¢n t√≠ch ƒë∆°n h√†ng...
// // // // //             </p>
// // // // //           )}
// // // // //           {step === "done" && orderResult && (
// // // // //             <div className="mt-2 text-sm text-green-600">
// // // // //               ‚úÖ {orderResult.message}
// // // // //             </div>
// // // // //           )}

// // // // //           {/* üëá Subtitle AI ƒëang n√≥i */}
// // // // //           {aiSpeechText && (
// // // // //             <div className="mt-4 px-3 py-2 rounded-md bg-yellow-100 text-yellow-800 text-sm border border-yellow-300 animate-pulse">
// // // // //               ü§ñ <strong>AI:</strong> {aiSpeechText}
// // // // //             </div>
// // // // //           )}
// // // // //         </motion.div>
// // // // //       )}
// // // // //     </motion.div>
// // // // //   );
// // // // // }

// // // // "use client";

// // // // import { useState, useRef, useEffect } from "react";
// // // // import { Bot, Mic, Send } from "lucide-react";
// // // // import { motion } from "framer-motion";

// // // // // üëá Fix l·ªói no-explicit-any

// // // // declare global {
// // // //   interface Window {
// // // //     webkitSpeechRecognition: any;
// // // //   }

// // // //   interface SpeechRecognitionEvent extends Event {
// // // //     results: SpeechRecognitionResultList;
// // // //   }
// // // // }
// // // // // ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu
// // // // interface OrderInfo {
// // // //   product: string;
// // // //   quantity: number;
// // // //   size: string;
// // // //   address: string;
// // // // }

// // // // interface OrderResult {
// // // //   message: string;
// // // //   payment_url?: string;
// // // // }

// // // // type Step = "idle" | "listening" | "parsing" | "confirming" | "done";

// // // // export default function VoiceQuickOrderFlexible() {
// // // //   const [voiceText, setVoiceText] = useState<string>("");
// // // //   const [orderInfo, setOrderInfo] = useState<OrderInfo | null>(null);
// // // //   const [orderResult, setOrderResult] = useState<OrderResult | null>(null);
// // // //   const [step, setStep] = useState<Step>("idle");
// // // //   const [paymentMethod, setPaymentMethod] = useState<1 | 2>(1);
// // // //   const recognitionRef = useRef<SpeechRecognition | null>(null);
// // // //   const [showWidget, setShowWidget] = useState<boolean>(false);
// // // //   const [aiSpeechText, setAiSpeechText] = useState<string>(""); // üëà subtitle AI n√≥i

// // // //   useEffect(() => {
// // // //     if (showWidget && step === "idle") {
// // // //       speak("Xin ch√†o! B·∫°n mu·ªën ƒë·∫∑t m√≥n g√¨ h√¥m nay?");
// // // //     }
// // // //   }, [showWidget, step]);

// // // //   const speak = (text: string, callback?: () => void) => {
// // // //     if ("speechSynthesis" in window) {
// // // //       const utter = new SpeechSynthesisUtterance(text);
// // // //       utter.lang = "vi-VN";
// // // //       setAiSpeechText(text);
// // // //       utter.onend = () => {
// // // //         setAiSpeechText("");
// // // //         if (callback) callback();
// // // //       };
// // // //       window.speechSynthesis.speak(utter);
// // // //     }
// // // //   };

// // // //   const waitForVoiceConfirm = (): Promise<"yes" | "no"> => {
// // // //     return new Promise((resolve) => {
// // // //       const recognition = new window.webkitSpeechRecognition();
// // // //       recognition.lang = "vi-VN";
// // // //       recognition.start();

// // // //       recognition.onresult = (event: SpeechRecognitionEvent) => {
// // // //         const response = event.results[0][0].transcript.toLowerCase();
// // // //         if (response.includes("ƒë·ªìng √Ω") || response.includes("ok")) {
// // // //           resolve("yes");
// // // //         } else {
// // // //           resolve("no");
// // // //         }
// // // //       };

// // // //       recognition.onerror = () => resolve("no");
// // // //     });
// // // //   };

// // // //   const waitForVoicePaymentMethod = (): Promise<1 | 2> => {
// // // //     return new Promise((resolve) => {
// // // //       const recognition = new window.webkitSpeechRecognition();
// // // //       recognition.lang = "vi-VN";
// // // //       recognition.start();

// // // //       recognition.onresult = (event: SpeechRecognitionEvent) => {
// // // //         const response = event.results[0][0].transcript.toLowerCase();
// // // //         if (response.includes("ti·ªÅn m·∫∑t")) {
// // // //           resolve(1);
// // // //         } else if (response.includes("chuy·ªÉn kho·∫£n")) {
// // // //           resolve(2);
// // // //         } else {
// // // //           resolve(1);
// // // //         }
// // // //       };

// // // //       recognition.onerror = () => resolve(1);
// // // //     });
// // // //   };

// // // //   const startVoice = () => {
// // // //     if (!("webkitSpeechRecognition" in window)) {
// // // //       alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ voice!");
// // // //       return;
// // // //     }

// // // //     setStep("listening");
// // // //     const recognition = new window.webkitSpeechRecognition();
// // // //     recognition.lang = "vi-VN";

// // // //     recognition.onresult = (event: SpeechRecognitionEvent) => {
// // // //       const text = event.results[0][0].transcript;
// // // //       setVoiceText(text);
// // // //       parseOrder(text);
// // // //     };

// // // //     recognition.start();
// // // //     recognitionRef.current = recognition;
// // // //   };

// // // //   const parseOrder = async (text: string) => {
// // // //     setStep("parsing");
// // // //     const token = localStorage.getItem("token");

// // // //     const res = await fetch("http://localhost:8000/api/voice-order/parse", {
// // // //       method: "POST",
// // // //       headers: {
// // // //         "Content-Type": "application/json",
// // // //         Authorization: `Bearer ${token}`,
// // // //       },
// // // //       body: JSON.stringify({ text }),
// // // //     });

// // // //     const data: OrderInfo = await res.json();
// // // //     setOrderInfo(data);
// // // //     setStep("confirming");

// // // //     const confirmText = `B·∫°n mu·ªën mua ${data.quantity} ${data.product} size ${data.size}, giao v·ªÅ ${data.address}. N√≥i "ƒê·ªìng √Ω" ƒë·ªÉ x√°c nh·∫≠n, ho·∫∑c "kh√¥ng" ƒë·ªÉ h·ªßy.`;

// // // //     speak(confirmText, async () => {
// // // //       const result = await waitForVoiceConfirm();
// // // //       if (result === "yes") {
// // // //         speak(
// // // //           'Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n: "thanh to√°n b·∫±ng ti·ªÅn m·∫∑t" ho·∫∑c "chuy·ªÉn kho·∫£n".',
// // // //           async () => {
// // // //             const method = await waitForVoicePaymentMethod();
// // // //             setPaymentMethod(method);
// // // //             speak("X√°c nh·∫≠n ƒë·∫∑t h√†ng...");
// // // //             await handleQuickOrder(data, method);
// // // //           }
// // // //         );
// // // //       } else {
// // // //         speak("ƒê√£ hu·ª∑ ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
// // // //         setOrderInfo(null);
// // // //         setStep("idle");
// // // //       }
// // // //     });
// // // //   };

// // // //   const handleQuickOrder = async (orderData: OrderInfo, method: 1 | 2) => {
// // // //     const token = localStorage.getItem("token");
// // // //     const payload = {
// // // //       ...orderData,
// // // //       payment_id: method,
// // // //     };

// // // //     const res = await fetch("http://localhost:8000/api/voice-order/quick", {
// // // //       method: "POST",
// // // //       headers: {
// // // //         "Content-Type": "application/json",
// // // //         Authorization: `Bearer ${token}`,
// // // //       },
// // // //       body: JSON.stringify(payload),
// // // //     });

// // // //     const data: OrderResult = await res.json();
// // // //     setOrderResult(data);
// // // //     setStep("done");

// // // //     if (method === 2 && data.payment_url) {
// // // //       speak("ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPAY...");
// // // //       window.location.href = data.payment_url;
// // // //     } else {
// // // //       speak(data.message || "ƒê·∫∑t h√†ng th√†nh c√¥ng.");
// // // //     }
// // // //   };

// // // //   return (
// // // //     <motion.div
// // // //       drag
// // // //       dragConstraints={{ left: 0, top: 0, right: 500, bottom: 800 }}
// // // //       className="fixed bottom-20 right-4 z-50"
// // // //     >
// // // //       {!showWidget && (
// // // //         <div className="relative flex flex-col items-center group">
// // // //           <motion.div
// // // //             initial={{ opacity: 0 }}
// // // //             animate={{ opacity: [0, 1, 0] }}
// // // //             transition={{
// // // //               duration: 3,
// // // //               repeat: Infinity,
// // // //               ease: "easeInOut",
// // // //             }}
// // // //             className="mb-3 px-4 py-1 bg-white text-purple-600 text-sm font-semibold rounded-full border border-purple-300 shadow-md backdrop-blur-md"
// // // //           >
// // // //             üõí Mua h√†ng nhanh - nh·∫•n tui ƒëi!
// // // //           </motion.div>

// // // //           <motion.button
// // // //             whileHover={{ scale: 1.08 }}
// // // //             whileTap={{ scale: 0.95 }}
// // // //             onClick={() => setShowWidget(true)}
// // // //             className="rounded-full p-4 bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 text-white shadow-2xl transition-all duration-300"
// // // //           >
// // // //             <motion.div
// // // //               animate={{
// // // //                 scale: [1, 1.05, 1],
// // // //                 boxShadow: [
// // // //                   "0 0 0px rgba(255, 255, 255, 0.6)",
// // // //                   "0 0 20px rgba(255, 255, 255, 0.9)",
// // // //                   "0 0 0px rgba(255, 255, 255, 0.6)",
// // // //                 ],
// // // //               }}
// // // //               transition={{
// // // //                 duration: 4,
// // // //                 repeat: Infinity,
// // // //                 ease: "easeInOut",
// // // //               }}
// // // //             >
// // // //               <Bot size={24} />
// // // //             </motion.div>
// // // //           </motion.button>
// // // //         </div>
// // // //       )}

// // // //       {showWidget && (
// // // //         <motion.div
// // // //           initial={{ opacity: 0, scale: 0.95 }}
// // // //           animate={{ opacity: 1, scale: 1 }}
// // // //           exit={{ opacity: 0, scale: 0.95 }}
// // // //           className="bg-white shadow-2xl rounded-2xl w-80 p-4"
// // // //         >
// // // //           <div className="flex justify-between items-center mb-4">
// // // //             <h3 className="text-lg font-bold">ü§ñ DREAMS</h3>
// // // //             <button
// // // //               onClick={() => setShowWidget(false)}
// // // //               className="text-gray-400 hover:text-gray-600"
// // // //             >
// // // //               ‚úï
// // // //             </button>
// // // //           </div>

// // // //           <textarea
// // // //             className="w-full rounded-md border border-gray-300 p-2 text-sm mb-2"
// // // //             rows={3}
// // // //             placeholder="N√≥i ho·∫∑c nh·∫≠p n·ªôi dung ƒë·∫∑t h√†ng..."
// // // //             value={voiceText}
// // // //             onChange={(e) => setVoiceText(e.target.value)}
// // // //           />

// // // //           <div className="flex gap-2">
// // // //             <button
// // // //               onClick={startVoice}
// // // //               className="flex-1 flex items-center justify-center gap-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600"
// // // //             >
// // // //               <Mic size={16} /> N√≥i
// // // //             </button>
// // // //             <button
// // // //               onClick={() => parseOrder(voiceText)}
// // // //               disabled={!voiceText.trim()}
// // // //               className="flex-1 flex items-center justify-center gap-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 disabled:opacity-50"
// // // //             >
// // // //               <Send size={16} /> G·ª≠i
// // // //             </button>
// // // //           </div>

// // // //           {step === "listening" && (
// // // //             <p className="text-xs text-blue-500 mt-2">
// // // //               üéß ƒêang nghe gi·ªçng n√≥i...
// // // //             </p>
// // // //           )}
// // // //           {step === "parsing" && (
// // // //             <p className="text-xs text-gray-500 mt-2">
// // // //               üîé ƒêang ph√¢n t√≠ch ƒë∆°n h√†ng...
// // // //             </p>
// // // //           )}
// // // //           {step === "done" && orderResult && (
// // // //             <div className="mt-2 text-sm text-green-600">
// // // //               ‚úÖ {orderResult.message}
// // // //             </div>
// // // //           )}

// // // //           {/* üëá Hi·ªÉn th·ªã orderInfo */}
// // // //           {orderInfo && (
// // // //             <div className="mt-2 text-sm text-gray-700">
// // // //               üõí S·∫£n ph·∫©m: {orderInfo.product} - S·ªë l∆∞·ª£ng: {orderInfo.quantity}{" "}
// // // //               - Size: {orderInfo.size}
// // // //               <br />
// // // //               üìç Giao ƒë·∫øn: {orderInfo.address}
// // // //             </div>
// // // //           )}

// // // //           {/* üëá Hi·ªÉn th·ªã payment method */}
// // // //           {step === "confirming" && (
// // // //             <p className="text-xs text-purple-600 mt-1">
// // // //               üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n:{" "}
// // // //               {paymentMethod === 1 ? "Ti·ªÅn m·∫∑t" : "Chuy·ªÉn kho·∫£n"}
// // // //             </p>
// // // //           )}

// // // //           {/* üëá Subtitle AI ƒëang n√≥i */}
// // // //           {aiSpeechText && (
// // // //             <div className="mt-4 px-3 py-2 rounded-md bg-yellow-100 text-yellow-800 text-sm border border-yellow-300 animate-pulse">
// // // //               ü§ñ <strong>AI:</strong> {aiSpeechText}
// // // //             </div>
// // // //           )}
// // // //         </motion.div>
// // // //       )}
// // // //     </motion.div>
// // // //   );
// // // // }

// // "use client";

// // import { useState, useRef, useEffect } from "react";
// // import { Bot, Mic, Send } from "lucide-react";
// // import { motion } from "framer-motion";

// // // TypeScript interfaces for Speech Recognition
// // interface SpeechRecognition extends EventTarget {
// //   continuous: boolean;
// //   interimResults: boolean;
// //   lang: string;
// //   start(): void;
// //   stop(): void;
// //   abort(): void;
// //   onresult:
// //     | ((this: SpeechRecognition, ev: SpeechRecognitionEvent) => void)
// //     | null;
// //   onerror:
// //     | ((this: SpeechRecognition, ev: SpeechRecognitionErrorEvent) => void)
// //     | null;
// //   onstart: ((this: SpeechRecognition, ev: Event) => void) | null;
// //   onend: ((this: SpeechRecognition, ev: Event) => void) | null;
// // }

// // interface SpeechRecognitionStatic {
// //   new (): SpeechRecognition;
// // }

// // interface SpeechRecognitionEvent extends Event {
// //   readonly resultIndex: number;
// //   readonly results: SpeechRecognitionResultList;
// // }

// // interface SpeechRecognitionErrorEvent extends Event {
// //   readonly error: string;
// //   readonly message: string;
// // }

// // interface SpeechRecognitionResultList {
// //   readonly length: number;
// //   item(index: number): SpeechRecognitionResult;
// //   [index: number]: SpeechRecognitionResult;
// // }

// // interface SpeechRecognitionResult {
// //   readonly length: number;
// //   readonly isFinal: boolean;
// //   item(index: number): SpeechRecognitionAlternative;
// //   [index: number]: SpeechRecognitionAlternative;
// // }

// // interface SpeechRecognitionAlternative {
// //   readonly transcript: string;
// //   readonly confidence: number;
// // }

// // declare global {
// //   interface Window {
// //     webkitSpeechRecognition: SpeechRecognitionStatic;
// //     SpeechRecognition: SpeechRecognitionStatic;
// //   }
// // }

// // // ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu
// // interface OrderInfo {
// //   product: string;
// //   quantity: number;
// //   size: string;
// //   address: string;
// // }

// // interface OrderResult {
// //   message: string;
// //   payment_url?: string;
// // }

// // type Step = "idle" | "listening" | "parsing" | "confirming" | "done";

// // export default function VoiceQuickOrderFlexible() {
// //   const [voiceText, setVoiceText] = useState<string>("");
// //   const [orderInfo, setOrderInfo] = useState<OrderInfo | null>(null);
// //   const [orderResult, setOrderResult] = useState<OrderResult | null>(null);
// //   const [step, setStep] = useState<Step>("idle");
// //   const [paymentMethod, setPaymentMethod] = useState<1 | 2>(1);
// //   const recognitionRef = useRef<SpeechRecognition | null>(null);
// //   const [showWidget, setShowWidget] = useState<boolean>(false);
// //   const [aiSpeechText, setAiSpeechText] = useState<string>(""); // subtitle AI n√≥i

// //   useEffect(() => {
// //     if (showWidget && step === "idle") {
// //       speak("Xin ch√†o! B·∫°n mu·ªën ƒë·∫∑t m√≥n g√¨ h√¥m nay?");
// //     }
// //   }, [showWidget, step]);

// //   const speak = (text: string, callback?: () => void): void => {
// //     if ("speechSynthesis" in window) {
// //       const utter = new SpeechSynthesisUtterance(text);
// //       utter.lang = "vi-VN";
// //       setAiSpeechText(text);
// //       utter.onend = () => {
// //         setAiSpeechText("");
// //         if (callback) callback();
// //       };
// //       window.speechSynthesis.speak(utter);
// //     }
// //   };

// //   const waitForVoiceConfirm = (): Promise<"yes" | "no"> => {
// //     return new Promise((resolve) => {
// //       const SpeechRecognitionConstructor =
// //         window.webkitSpeechRecognition || window.SpeechRecognition;
// //       if (!SpeechRecognitionConstructor) {
// //         resolve("no");
// //         return;
// //       }

// //       const recognition = new SpeechRecognitionConstructor();
// //       recognition.lang = "vi-VN";
// //       recognition.start();

// //       recognition.onresult = (event: SpeechRecognitionEvent) => {
// //         const response = event.results[0][0].transcript.toLowerCase();
// //         if (response.includes("ƒë·ªìng √Ω") || response.includes("ok")) {
// //           resolve("yes");
// //         } else {
// //           resolve("no");
// //         }
// //       };

// //       recognition.onerror = () => resolve("no");
// //     });
// //   };

// //   const waitForVoicePaymentMethod = (): Promise<1 | 2> => {
// //     return new Promise((resolve) => {
// //       const SpeechRecognitionConstructor =
// //         window.webkitSpeechRecognition || window.SpeechRecognition;
// //       if (!SpeechRecognitionConstructor) {
// //         resolve(1);
// //         return;
// //       }

// //       const recognition = new SpeechRecognitionConstructor();
// //       recognition.lang = "vi-VN";
// //       recognition.start();

// //       recognition.onresult = (event: SpeechRecognitionEvent) => {
// //         const response = event.results[0][0].transcript.toLowerCase();
// //         if (response.includes("ti·ªÅn m·∫∑t")) {
// //           resolve(1);
// //         } else if (response.includes("chuy·ªÉn kho·∫£n")) {
// //           resolve(2);
// //         } else {
// //           resolve(1);
// //         }
// //       };

// //       recognition.onerror = () => resolve(1);
// //     });
// //   };

// //   const startVoice = (): void => {
// //     const SpeechRecognitionConstructor =
// //       window.webkitSpeechRecognition || window.SpeechRecognition;
// //     if (!SpeechRecognitionConstructor) {
// //       alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ voice!");
// //       return;
// //     }

// //     setStep("listening");
// //     const recognition = new SpeechRecognitionConstructor();
// //     recognition.lang = "vi-VN";

// //     recognition.onresult = (event: SpeechRecognitionEvent) => {
// //       const text = event.results[0][0].transcript;
// //       setVoiceText(text);
// //       parseOrder(text);
// //     };

// //     recognition.onerror = (event: SpeechRecognitionErrorEvent) => {
// //       console.error("Speech recognition error:", event.error);
// //       setStep("idle");
// //     };

// //     recognition.start();
// //     recognitionRef.current = recognition;
// //   };

// //   const parseOrder = async (text: string): Promise<void> => {
// //     setStep("parsing");
// //     const token = localStorage.getItem("token");

// //     try {
// //       const res = await fetch("http://localhost:8000/api/voice-order/parse", {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           ...(token && { Authorization: `Bearer ${token}` }),
// //         },
// //         body: JSON.stringify({ text }),
// //       });

// //       if (!res.ok) {
// //         throw new Error(`HTTP error! status: ${res.status}`);
// //       }

// //       const data: OrderInfo = await res.json();
// //       setOrderInfo(data);
// //       setStep("confirming");

// //       const confirmText = `B·∫°n mu·ªën mua ${data.quantity} ${data.product} size ${data.size}, giao v·ªÅ ${data.address}. N√≥i "ƒê·ªìng √Ω" ƒë·ªÉ x√°c nh·∫≠n, ho·∫∑c "kh√¥ng" ƒë·ªÉ h·ªßy.`;

// //       speak(confirmText, async () => {
// //         const result = await waitForVoiceConfirm();
// //         if (result === "yes") {
// //           speak(
// //             'Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n: "thanh to√°n b·∫±ng ti·ªÅn m·∫∑t" ho·∫∑c "chuy·ªÉn kho·∫£n".',
// //             async () => {
// //               const method = await waitForVoicePaymentMethod();
// //               setPaymentMethod(method);
// //               speak("X√°c nh·∫≠n ƒë·∫∑t h√†ng...");
// //               await handleQuickOrder(data, method);
// //             }
// //           );
// //         } else {
// //           speak("ƒê√£ hu·ª∑ ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
// //           setOrderInfo(null);
// //           setStep("idle");
// //         }
// //       });
// //     } catch (error) {
// //       console.error("Error parsing order:", error);
// //       speak("C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
// //       setStep("idle");
// //     }
// //   };

// //   const handleQuickOrder = async (
// //     orderData: OrderInfo,
// //     method: 1 | 2
// //   ): Promise<void> => {
// //     const token = localStorage.getItem("token");
// //     const payload = {
// //       ...orderData,
// //       payment_id: method,
// //     };

// //     try {
// //       const res = await fetch("http://localhost:8000/api/voice-order/quick", {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           ...(token && { Authorization: `Bearer ${token}` }),
// //         },
// //         body: JSON.stringify(payload),
// //       });

// //       if (!res.ok) {
// //         throw new Error(`HTTP error! status: ${res.status}`);
// //       }

// //       const data: OrderResult = await res.json();
// //       setOrderResult(data);
// //       setStep("done");

// //       if (method === 2 && data.payment_url) {
// //         speak("ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPAY...");
// //         window.location.href = data.payment_url;
// //       } else {
// //         speak(data.message || "ƒê·∫∑t h√†ng th√†nh c√¥ng.");
// //       }
// //     } catch (error) {
// //       console.error("Error processing order:", error);
// //       speak("C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
// //       setStep("idle");
// //     }
// //   };

// //   const handleTextChange = (
// //     e: React.ChangeEvent<HTMLTextAreaElement>
// //   ): void => {
// //     setVoiceText(e.target.value);
// //   };

// //   const handleParseClick = (): void => {
// //     if (voiceText.trim()) {
// //       parseOrder(voiceText);
// //     }
// //   };

// //   const handleCloseWidget = (): void => {
// //     setShowWidget(false);
// //     setStep("idle");
// //     setVoiceText("");
// //     setOrderInfo(null);
// //     setOrderResult(null);
// //     setAiSpeechText("");
// //   };

// //   return (
// //     <motion.div
// //       drag
// //       dragConstraints={{ left: 0, top: 0, right: 500, bottom: 800 }}
// //       className="fixed bottom-20 right-4 z-50"
// //     >
// //       {!showWidget && (
// //         <div className="relative flex flex-col items-center group">
// //           <motion.div
// //             initial={{ opacity: 0 }}
// //             animate={{ opacity: [0, 1, 0] }}
// //             transition={{
// //               duration: 3,
// //               repeat: Infinity,
// //               ease: "easeInOut",
// //             }}
// //             className="mb-3 px-4 py-1 bg-white text-purple-600 text-sm font-semibold rounded-full border border-purple-300 shadow-md backdrop-blur-md"
// //           >
// //             üõí Mua h√†ng nhanh - nh·∫•n tui ƒëi!
// //           </motion.div>

// //           <motion.button
// //             whileHover={{ scale: 1.08 }}
// //             whileTap={{ scale: 0.95 }}
// //             onClick={() => setShowWidget(true)}
// //             className="rounded-full p-4 bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 text-white shadow-2xl transition-all duration-300"
// //           >
// //             <motion.div
// //               animate={{
// //                 scale: [1, 1.05, 1],
// //                 boxShadow: [
// //                   "0 0 0px rgba(255, 255, 255, 0.6)",
// //                   "0 0 20px rgba(255, 255, 255, 0.9)",
// //                   "0 0 0px rgba(255, 255, 255, 0.6)",
// //                 ],
// //               }}
// //               transition={{
// //                 duration: 4,
// //                 repeat: Infinity,
// //                 ease: "easeInOut",
// //               }}
// //             >
// //               <Bot size={24} />
// //             </motion.div>
// //           </motion.button>
// //         </div>
// //       )}

// //       {showWidget && (
// //         <motion.div
// //           initial={{ opacity: 0, scale: 0.95 }}
// //           animate={{ opacity: 1, scale: 1 }}
// //           exit={{ opacity: 0, scale: 0.95 }}
// //           className="bg-white shadow-2xl rounded-2xl w-80 p-4"
// //         >
// //           <div className="flex justify-between items-center mb-4">
// //             <h3 className="text-lg font-bold">ü§ñ DREAMS</h3>
// //             <button
// //               onClick={handleCloseWidget}
// //               className="text-gray-400 hover:text-gray-600"
// //             >
// //               ‚úï
// //             </button>
// //           </div>

// //           <textarea
// //             className="w-full rounded-md border border-gray-300 p-2 text-sm mb-2"
// //             rows={3}
// //             placeholder="N√≥i ho·∫∑c nh·∫≠p n·ªôi dung ƒë·∫∑t h√†ng..."
// //             value={voiceText}
// //             onChange={handleTextChange}
// //           />

// //           <div className="flex gap-2">
// //             <button
// //               onClick={startVoice}
// //               className="flex-1 flex items-center justify-center gap-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600"
// //             >
// //               <Mic size={16} /> N√≥i
// //             </button>
// //             <button
// //               onClick={handleParseClick}
// //               disabled={!voiceText.trim()}
// //               className="flex-1 flex items-center justify-center gap-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 disabled:opacity-50"
// //             >
// //               <Send size={16} /> G·ª≠i
// //             </button>
// //           </div>

// //           {step === "listening" && (
// //             <p className="text-xs text-blue-500 mt-2">
// //               üéß ƒêang nghe gi·ªçng n√≥i...
// //             </p>
// //           )}
// //           {step === "parsing" && (
// //             <p className="text-xs text-gray-500 mt-2">
// //               üîé ƒêang ph√¢n t√≠ch ƒë∆°n h√†ng...
// //             </p>
// //           )}
// //           {step === "done" && orderResult && (
// //             <div className="mt-2 text-sm text-green-600">
// //               ‚úÖ {orderResult.message}
// //             </div>
// //           )}

// //           {/* Hi·ªÉn th·ªã orderInfo */}
// //           {orderInfo && (
// //             <div className="mt-2 text-sm text-gray-700">
// //               üõí S·∫£n ph·∫©m: {orderInfo.product} - S·ªë l∆∞·ª£ng: {orderInfo.quantity}{" "}
// //               - Size: {orderInfo.size}
// //               <br />
// //               üìç Giao ƒë·∫øn: {orderInfo.address}
// //             </div>
// //           )}

// //           {/* Hi·ªÉn th·ªã payment method */}
// //           {step === "confirming" && (
// //             <p className="text-xs text-purple-600 mt-1">
// //               üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n:{" "}
// //               {paymentMethod === 1 ? "Ti·ªÅn m·∫∑t" : "Chuy·ªÉn kho·∫£n"}
// //             </p>
// //           )}

// //           {/* Subtitle AI ƒëang n√≥i */}
// //           {aiSpeechText && (
// //             <div className="mt-4 px-3 py-2 rounded-md bg-yellow-100 text-yellow-800 text-sm border border-yellow-300 animate-pulse">
// //               ü§ñ <strong>AI:</strong> {aiSpeechText}
// //             </div>
// //           )}
// //         </motion.div>
// //       )}
// //     </motion.div>
// //   );
// // }

// "use client";

// import { useState, useRef, useEffect } from "react";
// import {
//   Bot,
//   Mic,
//   Send,
//   X,
//   Globe,
//   Volume2,
//   VolumeX,
//   ShoppingBag,
//   MapPin,
//   Package,
//   CreditCard,
//   Clock,
// } from "lucide-react";

// // TypeScript interfaces for Speech Recognition
// interface SpeechRecognition extends EventTarget {
//   continuous: boolean;
//   interimResults: boolean;
//   lang: string;
//   start(): void;
//   stop(): void;
//   abort(): void;
//   onresult:
//     | ((this: SpeechRecognition, ev: SpeechRecognitionEvent) => void)
//     | null;
//   onerror:
//     | ((this: SpeechRecognition, ev: SpeechRecognitionErrorEvent) => void)
//     | null;
//   onstart: ((this: SpeechRecognition, ev: Event) => void) | null;
//   onend: ((this: SpeechRecognition, ev: Event) => void) | null;
// }

// interface SpeechRecognitionStatic {
//   new (): SpeechRecognition;
// }

// interface SpeechRecognitionEvent extends Event {
//   readonly resultIndex: number;
//   readonly results: SpeechRecognitionResultList;
// }

// interface SpeechRecognitionErrorEvent extends Event {
//   readonly error: string;
//   readonly message: string;
// }

// interface SpeechRecognitionResultList {
//   readonly length: number;
//   item(index: number): SpeechRecognitionResult;
//   [index: number]: SpeechRecognitionResult;
// }

// interface SpeechRecognitionResult {
//   readonly length: number;
//   readonly isFinal: boolean;
//   item(index: number): SpeechRecognitionAlternative;
//   [index: number]: SpeechRecognitionAlternative;
// }

// interface SpeechRecognitionAlternative {
//   readonly transcript: string;
//   readonly confidence: number;
// }

// declare global {
//   interface Window {
//     webkitSpeechRecognition: SpeechRecognitionStatic;
//     SpeechRecognition: SpeechRecognitionStatic;
//   }
// }

// interface OrderInfo {
//   product: string;
//   quantity: number;
//   size: string;
//   address: string;
// }

// interface OrderResult {
//   message: string;
//   payment_url?: string;
// }

// type Step = "idle" | "listening" | "parsing" | "confirming" | "done";

// // Multilingual support
// const translations = {
//   en: {
//     quickOrder: "Quick Order",
//     clickMe: "üõí Quick order - click me!",
//     hello: "Hello! What would you like to order today?",
//     speakOrType: "Speak or type your order...",
//     speak: "Speak",
//     send: "Send",
//     listening: "üéß Listening...",
//     parsing: "üîé Analyzing order...",
//     confirming: "Confirming order...",
//     orderSuccess: "‚úÖ Order successful!",
//     product: "Product",
//     quantity: "Quantity",
//     size: "Size",
//     deliverTo: "Deliver to",
//     paymentMethod: "Payment method",
//     cash: "Cash",
//     transfer: "Bank transfer",
//     agree: "agree",
//     ok: "ok",
//     yes: "yes",
//     cancel: "cancel",
//     no: "no",
//     confirmOrder:
//       "You want to buy {quantity} {product} size {size}, deliver to {address}. Say 'agree' to confirm, or 'cancel' to abort.",
//     choosePayment: "Choose payment method: 'cash' or 'bank transfer'.",
//     orderCanceled: "Order canceled. Please try again.",
//     errorProcessing: "Error processing order. Please try again.",
//     redirectingPayment: "Redirecting to VNPAY payment...",
//     mute: "Mute",
//     unmute: "Unmute",
//   },
//   vi: {
//     quickOrder: "ƒê·∫∑t h√†ng nhanh",
//     clickMe: "üõí Mua h√†ng nhanh - nh·∫•n tui ƒëi!",
//     hello: "Xin ch√†o! B·∫°n mu·ªën ƒë·∫∑t m√≥n g√¨ h√¥m nay?",
//     speakOrType: "N√≥i ho·∫∑c nh·∫≠p n·ªôi dung ƒë·∫∑t h√†ng...",
//     speak: "N√≥i",
//     send: "G·ª≠i",
//     listening: "üéß ƒêang nghe gi·ªçng n√≥i...",
//     parsing: "üîé ƒêang ph√¢n t√≠ch ƒë∆°n h√†ng...",
//     confirming: "ƒêang x√°c nh·∫≠n ƒë∆°n h√†ng...",
//     orderSuccess: "‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!",
//     product: "S·∫£n ph·∫©m",
//     quantity: "S·ªë l∆∞·ª£ng",
//     size: "Size",
//     deliverTo: "Giao ƒë·∫øn",
//     paymentMethod: "Ph∆∞∆°ng th·ª©c thanh to√°n",
//     cash: "Ti·ªÅn m·∫∑t",
//     transfer: "Chuy·ªÉn kho·∫£n",
//     agree: "ƒë·ªìng √Ω",
//     ok: "ok",
//     yes: "c√≥",
//     cancel: "kh√¥ng",
//     no: "kh√¥ng",
//     confirmOrder:
//       "B·∫°n mu·ªën mua {quantity} {product} size {size}, giao v·ªÅ {address}. N√≥i 'ƒë·ªìng √Ω' ƒë·ªÉ x√°c nh·∫≠n, ho·∫∑c 'kh√¥ng' ƒë·ªÉ h·ªßy.",
//     choosePayment:
//       "Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n: 'ti·ªÅn m·∫∑t' ho·∫∑c 'chuy·ªÉn kho·∫£n'.",
//     orderCanceled: "ƒê√£ hu·ª∑ ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.",
//     errorProcessing: "C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.",
//     redirectingPayment: "ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPAY...",
//     mute: "T·∫Øt ti·∫øng",
//     unmute: "B·∫≠t ti·∫øng",
//   },
//   zh: {
//     quickOrder: "Âø´ÈÄü‰∏ãÂçï",
//     clickMe: "üõí Âø´ÈÄüË¥≠‰π∞ - ÁÇπÂáªÊàëÔºÅ",
//     hello: "ÊÇ®Â•ΩÔºÅ‰ªäÂ§©ÊÉ≥Ë¶ÅËÆ¢Ë¥≠‰ªÄ‰πàÔºü",
//     speakOrType: "ËØ¥ËØùÊàñËæìÂÖ•ÊÇ®ÁöÑËÆ¢Âçï...",
//     speak: "ËØ¥ËØù",
//     send: "ÂèëÈÄÅ",
//     listening: "üéß Ê≠£Âú®Âê¨Âèñ...",
//     parsing: "üîé Ê≠£Âú®ÂàÜÊûêËÆ¢Âçï...",
//     confirming: "Ê≠£Âú®Á°ÆËÆ§ËÆ¢Âçï...",
//     orderSuccess: "‚úÖ ËÆ¢ÂçïÊàêÂäüÔºÅ",
//     product: "‰∫ßÂìÅ",
//     quantity: "Êï∞Èáè",
//     size: "Â∞∫ÂØ∏",
//     deliverTo: "ÈÄÅËææ",
//     paymentMethod: "ÊîØ‰ªòÊñπÂºè",
//     cash: "Áé∞Èáë",
//     transfer: "Èì∂Ë°åËΩ¨Ë¥¶",
//     agree: "ÂêåÊÑè",
//     ok: "Â•ΩÁöÑ",
//     yes: "ÊòØ",
//     cancel: "ÂèñÊ∂à",
//     no: "‰∏ç",
//     confirmOrder:
//       "ÊÇ®ÊÉ≥Ë¥≠‰π∞ {quantity} ‰∏™ {product} Â∞∫ÂØ∏ {size}ÔºåÈÄÅÂà∞ {address}„ÄÇËØ¥'ÂêåÊÑè'Á°ÆËÆ§ÔºåÊàñ'ÂèñÊ∂à'‰∏≠Ê≠¢„ÄÇ",
//     choosePayment: "ÈÄâÊã©ÊîØ‰ªòÊñπÂºèÔºö'Áé∞Èáë'Êàñ'Èì∂Ë°åËΩ¨Ë¥¶'„ÄÇ",
//     orderCanceled: "ËÆ¢ÂçïÂ∑≤ÂèñÊ∂à„ÄÇËØ∑ÈáçËØï„ÄÇ",
//     errorProcessing: "Â§ÑÁêÜËÆ¢ÂçïÊó∂Âá∫Èîô„ÄÇËØ∑ÈáçËØï„ÄÇ",
//     redirectingPayment: "Ê≠£Âú®Ë∑≥ËΩ¨Âà∞VNPAYÊîØ‰ªò...",
//     mute: "ÈùôÈü≥",
//     unmute: "ÂèñÊ∂àÈùôÈü≥",
//   },
//   es: {
//     quickOrder: "Pedido r√°pido",
//     clickMe: "üõí Pedido r√°pido - ¬°haz clic!",
//     hello: "¬°Hola! ¬øQu√© te gustar√≠a pedir hoy?",
//     speakOrType: "Habla o escribe tu pedido...",
//     speak: "Hablar",
//     send: "Enviar",
//     listening: "üéß Escuchando...",
//     parsing: "üîé Analizando pedido...",
//     confirming: "Confirmando pedido...",
//     orderSuccess: "‚úÖ ¬°Pedido exitoso!",
//     product: "Producto",
//     quantity: "Cantidad",
//     size: "Talla",
//     deliverTo: "Entregar a",
//     paymentMethod: "M√©todo de pago",
//     cash: "Efectivo",
//     transfer: "Transferencia",
//     agree: "de acuerdo",
//     ok: "ok",
//     yes: "s√≠",
//     cancel: "cancelar",
//     no: "no",
//     confirmOrder:
//       "Quieres comprar {quantity} {product} talla {size}, entregar a {address}. Di 'de acuerdo' para confirmar, o 'cancelar' para abortar.",
//     choosePayment: "Elige m√©todo de pago: 'efectivo' o 'transferencia'.",
//     orderCanceled: "Pedido cancelado. Por favor intenta de nuevo.",
//     errorProcessing: "Error procesando pedido. Por favor intenta de nuevo.",
//     redirectingPayment: "Redirigiendo a pago VNPAY...",
//     mute: "Silenciar",
//     unmute: "Activar sonido",
//   },
// };

// type Language = keyof typeof translations;

// export default function VoiceQuickOrderFlexible() {
//   const [voiceText, setVoiceText] = useState<string>("");
//   const [orderInfo, setOrderInfo] = useState<OrderInfo | null>(null);
//   const [orderResult, setOrderResult] = useState<OrderResult | null>(null);
//   const [step, setStep] = useState<Step>("idle");
//   const [paymentMethod, setPaymentMethod] = useState<1 | 2>(1);
//   const [language, setLanguage] = useState<Language>("vi");
//   const [isMuted, setIsMuted] = useState<boolean>(false);
//   const recognitionRef = useRef<SpeechRecognition | null>(null);
//   const [showWidget, setShowWidget] = useState<boolean>(false);
//   const [aiSpeechText, setAiSpeechText] = useState<string>("");
//   const [isRecording, setIsRecording] = useState<boolean>(false);
//   const [pulseAnimation, setPulseAnimation] = useState<boolean>(true);

//   const t = translations[language];

//   useEffect(() => {
//     if (showWidget && step === "idle") {
//       speak(t.hello);
//     }
//   }, [showWidget, step, language]);

//   // Auto pulse animation
//   useEffect(() => {
//     const interval = setInterval(() => {
//       setPulseAnimation((prev) => !prev);
//     }, 3000);
//     return () => clearInterval(interval);
//   }, []);

//   const speak = (text: string, callback?: () => void): void => {
//     if ("speechSynthesis" in window && !isMuted) {
//       const utter = new SpeechSynthesisUtterance(text);
//       utter.lang =
//         language === "vi"
//           ? "vi-VN"
//           : language === "en"
//           ? "en-US"
//           : language === "zh"
//           ? "zh-CN"
//           : "es-ES";
//       setAiSpeechText(text);
//       utter.onend = () => {
//         setAiSpeechText("");
//         if (callback) callback();
//       };
//       window.speechSynthesis.speak(utter);
//     }
//   };

//   const waitForVoiceConfirm = (): Promise<"yes" | "no"> => {
//     return new Promise((resolve) => {
//       const SpeechRecognitionConstructor =
//         window.webkitSpeechRecognition || window.SpeechRecognition;
//       if (!SpeechRecognitionConstructor) {
//         resolve("no");
//         return;
//       }

//       const recognition = new SpeechRecognitionConstructor();
//       recognition.lang =
//         language === "vi"
//           ? "vi-VN"
//           : language === "en"
//           ? "en-US"
//           : language === "zh"
//           ? "zh-CN"
//           : "es-ES";
//       recognition.start();

//       recognition.onresult = (event: SpeechRecognitionEvent) => {
//         const response = event.results[0][0].transcript.toLowerCase();
//         const yesWords = [t.agree, t.ok, t.yes].map((w) => w.toLowerCase());
//         const noWords = [t.cancel, t.no].map((w) => w.toLowerCase());

//         if (yesWords.some((word) => response.includes(word))) {
//           resolve("yes");
//         } else if (noWords.some((word) => response.includes(word))) {
//           resolve("no");
//         } else {
//           resolve("no");
//         }
//       };

//       recognition.onerror = () => resolve("no");
//     });
//   };

//   const waitForVoicePaymentMethod = (): Promise<1 | 2> => {
//     return new Promise((resolve) => {
//       const SpeechRecognitionConstructor =
//         window.webkitSpeechRecognition || window.SpeechRecognition;
//       if (!SpeechRecognitionConstructor) {
//         resolve(1);
//         return;
//       }

//       const recognition = new SpeechRecognitionConstructor();
//       recognition.lang =
//         language === "vi"
//           ? "vi-VN"
//           : language === "en"
//           ? "en-US"
//           : language === "zh"
//           ? "zh-CN"
//           : "es-ES";
//       recognition.start();

//       recognition.onresult = (event: SpeechRecognitionEvent) => {
//         const response = event.results[0][0].transcript.toLowerCase();
//         if (response.includes(t.transfer.toLowerCase())) {
//           resolve(2);
//         } else {
//           resolve(1);
//         }
//       };

//       recognition.onerror = () => resolve(1);
//     });
//   };

//   const startVoice = (): void => {
//     const SpeechRecognitionConstructor =
//       window.webkitSpeechRecognition || window.SpeechRecognition;
//     if (!SpeechRecognitionConstructor) {
//       alert("Browser doesn't support voice recognition!");
//       return;
//     }

//     setStep("listening");
//     setIsRecording(true);
//     const recognition = new SpeechRecognitionConstructor();
//     recognition.lang =
//       language === "vi"
//         ? "vi-VN"
//         : language === "en"
//         ? "en-US"
//         : language === "zh"
//         ? "zh-CN"
//         : "es-ES";

//     recognition.onresult = (event: SpeechRecognitionEvent) => {
//       const text = event.results[0][0].transcript;
//       setVoiceText(text);
//       setIsRecording(false);
//       parseOrder(text);
//     };

//     recognition.onerror = (event: SpeechRecognitionErrorEvent) => {
//       console.error("Speech recognition error:", event.error);
//       setStep("idle");
//       setIsRecording(false);
//     };

//     recognition.start();
//     recognitionRef.current = recognition;
//   };

//   const parseOrder = async (text: string): Promise<void> => {
//     setStep("parsing");
//     const token = localStorage.getItem("token");

//     try {
//       const res = await fetch("http://localhost:8000/api/voice-order/parse", {
//         method: "POST",
//         headers: {
//           "Content-Type": "application/json",
//           ...(token && { Authorization: `Bearer ${token}` }),
//         },
//         body: JSON.stringify({ text }),
//       });

//       if (!res.ok) {
//         throw new Error(`HTTP error! status: ${res.status}`);
//       }

//       const data: OrderInfo = await res.json();
//       setOrderInfo(data);
//       setStep("confirming");

//       const confirmText = t.confirmOrder
//         .replace("{quantity}", data.quantity.toString())
//         .replace("{product}", data.product)
//         .replace("{size}", data.size)
//         .replace("{address}", data.address);

//       speak(confirmText, async () => {
//         const result = await waitForVoiceConfirm();
//         if (result === "yes") {
//           speak(t.choosePayment, async () => {
//             const method = await waitForVoicePaymentMethod();
//             setPaymentMethod(method);
//             speak(t.confirming);
//             await handleQuickOrder(data, method);
//           });
//         } else {
//           speak(t.orderCanceled);
//           setOrderInfo(null);
//           setStep("idle");
//         }
//       });
//     } catch (error) {
//       console.error("Error parsing order:", error);
//       speak(t.errorProcessing);
//       setStep("idle");
//     }
//   };

//   const handleQuickOrder = async (
//     orderData: OrderInfo,
//     method: 1 | 2
//   ): Promise<void> => {
//     const token = localStorage.getItem("token");
//     const payload = {
//       ...orderData,
//       payment_id: method,
//     };

//     try {
//       const res = await fetch("http://localhost:8000/api/voice-order/quick", {
//         method: "POST",
//         headers: {
//           "Content-Type": "application/json",
//           ...(token && { Authorization: `Bearer ${token}` }),
//         },
//         body: JSON.stringify(payload),
//       });

//       if (!res.ok) {
//         throw new Error(`HTTP error! status: ${res.status}`);
//       }

//       const data: OrderResult = await res.json();
//       setOrderResult(data);
//       setStep("done");

//       if (method === 2 && data.payment_url) {
//         speak(t.redirectingPayment);
//         setTimeout(() => {
//           window.location.href = data.payment_url!;
//         }, 2000);
//       } else {
//         speak(data.message || t.orderSuccess);
//       }
//     } catch (error) {
//       console.error("Error processing order:", error);
//       speak(t.errorProcessing);
//       setStep("idle");
//     }
//   };

//   const handleTextChange = (
//     e: React.ChangeEvent<HTMLTextAreaElement>
//   ): void => {
//     setVoiceText(e.target.value);
//   };

//   const handleParseClick = (): void => {
//     if (voiceText.trim()) {
//       parseOrder(voiceText);
//     }
//   };

//   const handleCloseWidget = (): void => {
//     setShowWidget(false);
//     setStep("idle");
//     setVoiceText("");
//     setOrderInfo(null);
//     setOrderResult(null);
//     setAiSpeechText("");
//     setIsRecording(false);
//     if (recognitionRef.current) {
//       recognitionRef.current.abort();
//     }
//   };

//   return (
//     <div className="fixed bottom-6 right-6 z-50">
//       {!showWidget && (
//         <div className="relative flex flex-col items-center group">
//           {/* Floating message */}
//           <div
//             className={`mb-4 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white text-sm font-bold rounded-full shadow-xl transform transition-all duration-700 ${
//               pulseAnimation ? "scale-105 shadow-2xl" : "scale-100"
//             }`}
//             style={{
//               background: "linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42)",
//               boxShadow: "0 8px 32px rgba(255, 107, 53, 0.4)",
//             }}
//           >
//             {t.clickMe}
//             <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-8 border-transparent border-t-orange-500"></div>
//           </div>

//           {/* Main bot button */}
//           <button
//             onClick={() => setShowWidget(true)}
//             className={`relative rounded-full p-5 bg-gradient-to-br from-orange-500 via-red-500 to-pink-500 text-white shadow-2xl transition-all duration-500 hover:scale-110 active:scale-95 ${
//               pulseAnimation ? "animate-pulse" : ""
//             }`}
//             style={{
//               background:
//                 "linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42, #e94e77)",
//               boxShadow: "0 12px 40px rgba(255, 107, 53, 0.5)",
//             }}
//           >
//             <div className="absolute inset-0 rounded-full bg-white opacity-20 animate-ping"></div>
//             <Bot size={28} className="relative z-10" />

//             {/* Floating particles */}
//             <div className="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full animate-bounce delay-75"></div>
//             <div className="absolute -bottom-1 -left-1 w-2 h-2 bg-green-400 rounded-full animate-bounce delay-150"></div>
//           </button>
//         </div>
//       )}

//       {showWidget && (
//         <div
//           className="bg-white shadow-2xl rounded-3xl w-96 overflow-hidden transform transition-all duration-500 animate-in slide-in-from-bottom-8"
//           style={{
//             boxShadow: "0 25px 80px rgba(0, 0, 0, 0.15)",
//             backdropFilter: "blur(20px)",
//           }}
//         >
//           {/* Header */}
//           <div className="bg-gradient-to-r from-orange-500 to-red-500 p-6 text-white relative overflow-hidden">
//             <div className="absolute inset-0 bg-black opacity-10"></div>
//             <div className="relative z-10 flex justify-between items-center">
//               <div className="flex items-center gap-3">
//                 <div className="p-2 bg-white bg-opacity-20 rounded-full">
//                   <ShoppingBag size={20} />
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-bold">{t.quickOrder}</h3>
//                   <p className="text-xs opacity-90">AI Assistant</p>
//                 </div>
//               </div>

//               <div className="flex items-center gap-2">
//                 {/* Language selector */}
//                 <select
//                   value={language}
//                   onChange={(e) => setLanguage(e.target.value as Language)}
//                   className="bg-white bg-opacity-20 text-white text-xs rounded-lg px-2 py-1 border-none outline-none"
//                 >
//                   <option value="vi" className="text-black">
//                     üáªüá≥ VI
//                   </option>
//                   <option value="en" className="text-black">
//                     üá∫üá∏ EN
//                   </option>
//                   <option value="zh" className="text-black">
//                     üá®üá≥ ZH
//                   </option>
//                   <option value="es" className="text-black">
//                     üá™üá∏ ES
//                   </option>
//                 </select>

//                 {/* Mute/Unmute button */}
//                 <button
//                   onClick={() => setIsMuted(!isMuted)}
//                   className="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition-all"
//                   title={isMuted ? t.unmute : t.mute}
//                 >
//                   {isMuted ? <VolumeX size={16} /> : <Volume2 size={16} />}
//                 </button>

//                 {/* Close button */}
//                 <button
//                   onClick={handleCloseWidget}
//                   className="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition-all"
//                 >
//                   <X size={16} />
//                 </button>
//               </div>
//             </div>

//             {/* Decorative wave */}
//             <div className="absolute bottom-0 left-0 right-0">
//               <svg viewBox="0 0 400 20" className="w-full h-5">
//                 <path
//                   d="M0,10 Q100,0 200,10 T400,10 L400,20 L0,20 Z"
//                   fill="white"
//                   opacity="0.1"
//                 />
//               </svg>
//             </div>
//           </div>

//           {/* Content */}
//           <div className="p-6 space-y-4">
//             {/* Text input */}
//             <div className="relative">
//               <textarea
//                 className="w-full rounded-2xl border-2 border-gray-200 p-4 text-sm resize-none focus:border-orange-400 focus:ring-4 focus:ring-orange-100 transition-all duration-300"
//                 rows={3}
//                 placeholder={t.speakOrType}
//                 value={voiceText}
//                 onChange={handleTextChange}
//               />
//               {voiceText && (
//                 <div className="absolute top-2 right-2 text-orange-500">
//                   <Package size={16} />
//                 </div>
//               )}
//             </div>

//             {/* Action buttons */}
//             <div className="flex gap-3">
//               <button
//                 onClick={startVoice}
//                 disabled={isRecording}
//                 className={`flex-1 flex items-center justify-center gap-2 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 ${
//                   isRecording
//                     ? "bg-gradient-to-r from-red-500 to-pink-500 text-white animate-pulse"
//                     : "bg-gradient-to-r from-orange-500 to-red-500 text-white hover:shadow-lg"
//                 }`}
//                 style={{
//                   boxShadow: isRecording
//                     ? "0 0 30px rgba(239, 68, 68, 0.5)"
//                     : "0 8px 25px rgba(255, 107, 53, 0.3)",
//                 }}
//               >
//                 <Mic
//                   size={18}
//                   className={isRecording ? "animate-bounce" : ""}
//                 />
//                 {isRecording ? "Recording..." : t.speak}
//               </button>

//               <button
//                 onClick={handleParseClick}
//                 disabled={!voiceText.trim()}
//                 className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-4 rounded-2xl font-semibold hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 active:scale-95"
//                 style={{
//                   boxShadow: "0 8px 25px rgba(16, 185, 129, 0.3)",
//                 }}
//               >
//                 <Send size={18} />
//                 {t.send}
//               </button>
//             </div>

//             {/* Status indicator */}
//             {step !== "idle" && (
//               <div className="flex items-center gap-3 p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200">
//                 <div className="flex-shrink-0">
//                   {step === "listening" && (
//                     <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
//                   )}
//                   {step === "parsing" && (
//                     <div className="w-3 h-3 bg-yellow-500 rounded-full animate-spin"></div>
//                   )}
//                   {step === "confirming" && (
//                     <div className="w-3 h-3 bg-orange-500 rounded-full animate-bounce"></div>
//                   )}
//                   {step === "done" && (
//                     <div className="w-3 h-3 bg-green-500 rounded-full"></div>
//                   )}
//                 </div>
//                 <p className="text-sm text-gray-700 font-medium">
//                   {step === "listening" && t.listening}
//                   {step === "parsing" && t.parsing}
//                   {step === "confirming" && t.confirming}
//                   {step === "done" && t.orderSuccess}
//                 </p>
//               </div>
//             )}

//             {/* Order info display */}
//             {orderInfo && (
//               <div className="bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl p-4 border border-orange-200 space-y-3">
//                 <div className="flex items-center gap-2 text-orange-600 font-semibold">
//                   <ShoppingBag size={18} />
//                   Order Details
//                 </div>

//                 <div className="grid grid-cols-2 gap-3 text-sm">
//                   <div className="flex items-center gap-2">
//                     <Package size={14} className="text-gray-500" />
//                     <span className="text-gray-600">{t.product}:</span>
//                     <span className="font-semibold text-gray-800">
//                       {orderInfo.product}
//                     </span>
//                   </div>

//                   <div className="flex items-center gap-2">
//                     <Clock size={14} className="text-gray-500" />
//                     <span className="text-gray-600">{t.quantity}:</span>
//                     <span className="font-semibold text-gray-800">
//                       {orderInfo.quantity}
//                     </span>
//                   </div>

//                   <div className="flex items-center gap-2">
//                     <Package size={14} className="text-gray-500" />
//                     <span className="text-gray-600">{t.size}:</span>
//                     <span className="font-semibold text-gray-800">
//                       {orderInfo.size}
//                     </span>
//                   </div>

//                   <div className="flex items-center gap-2">
//                     <CreditCard size={14} className="text-gray-500" />
//                     <span className="text-gray-600">{t.paymentMethod}:</span>
//                     <span className="font-semibold text-gray-800">
//                       {paymentMethod === 1 ? t.cash : t.transfer}
//                     </span>
//                   </div>
//                 </div>

//                 <div className="flex items-start gap-2 pt-2 border-t border-orange-200">
//                   <MapPin size={14} className="text-gray-500 mt-1" />
//                   <div>
//                     <span className="text-gray-600 text-sm">
//                       {t.deliverTo}:
//                     </span>
//                     <p className="font-semibold text-gray-800 text-sm">
//                       {orderInfo.address}
//                     </p>
//                   </div>
//                 </div>
//               </div>
//             )}

//             {/* Order result */}
//             {step === "done" && orderResult && (
//               <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-4 border border-green-200">
//                 <div className="flex items-center gap-2 text-green-600">
//                   <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
//                     <span className="text-white text-xs">‚úì</span>
//                   </div>
//                   <span className="font-semibold">{orderResult.message}</span>
//                 </div>
//               </div>
//             )}

//             {/* AI Speech subtitle */}
//             {aiSpeechText && (
//               <div className="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-2xl p-4 border border-yellow-200 animate-pulse">
//                 <div className="flex items-center gap-3">
//                   <div className="flex-shrink-0">
//                     <div className="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-full flex items-center justify-center">
//                       <Bot size={16} className="text-white" />
//                     </div>
//                   </div>
//                   <div className="flex-1">
//                     <p className="text-sm font-semibold text-yellow-800 mb-1">
//                       AI Assistant
//                     </p>
//                     <p className="text-sm text-yellow-700">{aiSpeechText}</p>
//                   </div>
//                   <div className="flex space-x-1">
//                     <div className="w-1 h-1 bg-yellow-500 rounded-full animate-bounce"></div>
//                     <div className="w-1 h-1 bg-yellow-500 rounded-full animate-bounce delay-75"></div>
//                     <div className="w-1 h-1 bg-yellow-500 rounded-full animate-bounce delay-150"></div>
//                   </div>
//                 </div>
//               </div>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

"use client";

import { useState, useRef, useEffect } from "react";
import {
  Bot,
  Mic,
  Send,
  X,
  Globe,
  Volume2,
  VolumeX,
  ShoppingBag,
  MapPin,
  Package,
  CreditCard,
  Clock,
} from "lucide-react";

// TypeScript interfaces for Speech Recognition
interface SpeechRecognition extends EventTarget {
  continuous: boolean;
  interimResults: boolean;
  lang: string;
  start(): void;
  stop(): void;
  abort(): void;
  onresult:
    | ((this: SpeechRecognition, ev: SpeechRecognitionEvent) => void)
    | null;
  onerror:
    | ((this: SpeechRecognition, ev: SpeechRecognitionErrorEvent) => void)
    | null;
  onstart: ((this: SpeechRecognition, ev: Event) => void) | null;
  onend: ((this: SpeechRecognition, ev: Event) => void) | null;
}

interface SpeechRecognitionStatic {
  new (): SpeechRecognition;
}

interface SpeechRecognitionEvent extends Event {
  readonly resultIndex: number;
  readonly results: SpeechRecognitionResultList;
}

interface SpeechRecognitionErrorEvent extends Event {
  readonly error: string;
  readonly message: string;
}

interface SpeechRecognitionResultList {
  readonly length: number;
  item(index: number): SpeechRecognitionResult;
  [index: number]: SpeechRecognitionResult;
}

interface SpeechRecognitionResult {
  readonly length: number;
  readonly isFinal: boolean;
  item(index: number): SpeechRecognitionAlternative;
  [index: number]: SpeechRecognitionAlternative;
}

interface SpeechRecognitionAlternative {
  readonly transcript: string;
  readonly confidence: number;
}

declare global {
  interface Window {
    webkitSpeechRecognition: SpeechRecognitionStatic;
    SpeechRecognition: SpeechRecognitionStatic;
  }
}

interface OrderInfo {
  product: string;
  quantity: number;
  size: string;
  address: string;
}

interface OrderResult {
  message: string;
  payment_url?: string;
}

type Step = "idle" | "listening" | "parsing" | "confirming" | "done";

// Comprehensive multilingual support
const translations = {
  // Vietnamese
  vi: {
    quickOrder: "ƒê·∫∑t h√†ng nhanh",
    clickMe: "üõí Mua h√†ng nhanh - nh·∫•n tui ƒëi!",
    hello: "Xin ch√†o! B·∫°n mu·ªën ƒë·∫∑t m√≥n g√¨ h√¥m nay?",
    speakOrType: "N√≥i ho·∫∑c nh·∫≠p n·ªôi dung ƒë·∫∑t h√†ng...",
    speak: "N√≥i",
    send: "G·ª≠i",
    listening: "üéß ƒêang nghe gi·ªçng n√≥i...",
    parsing: "üîé ƒêang ph√¢n t√≠ch ƒë∆°n h√†ng...",
    confirming: "ƒêang x√°c nh·∫≠n ƒë∆°n h√†ng...",
    orderSuccess: "‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!",
    product: "S·∫£n ph·∫©m",
    quantity: "S·ªë l∆∞·ª£ng",
    size: "Size",
    deliverTo: "Giao ƒë·∫øn",
    paymentMethod: "Ph∆∞∆°ng th·ª©c thanh to√°n",
    cash: "Ti·ªÅn m·∫∑t",
    transfer: "Chuy·ªÉn kho·∫£n",
    agree: "ƒë·ªìng √Ω",
    ok: "ok",
    yes: "c√≥",
    cancel: "kh√¥ng",
    no: "kh√¥ng",
    confirmOrder:
      "B·∫°n mu·ªën mua {quantity} {product} size {size}, giao v·ªÅ {address}. N√≥i 'ƒë·ªìng √Ω' ƒë·ªÉ x√°c nh·∫≠n, ho·∫∑c 'kh√¥ng' ƒë·ªÉ h·ªßy.",
    choosePayment:
      "Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n: 'ti·ªÅn m·∫∑t' ho·∫∑c 'chuy·ªÉn kho·∫£n'.",
    orderCanceled: "ƒê√£ hu·ª∑ ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.",
    errorProcessing: "C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.",
    redirectingPayment: "ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPAY...",
    mute: "T·∫Øt ti·∫øng",
    unmute: "B·∫≠t ti·∫øng",
    orderDetails: "Chi ti·∫øt ƒë∆°n h√†ng",
    waitingPayment: "Ch·ªù ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n...",
  },
  // English
  en: {
    quickOrder: "Quick Order",
    clickMe: "üõí Quick order - click me!",
    hello: "Hello! What would you like to order today?",
    speakOrType: "Speak or type your order...",
    speak: "Speak",
    send: "Send",
    listening: "üéß Listening...",
    parsing: "üîé Analyzing order...",
    confirming: "Confirming order...",
    orderSuccess: "‚úÖ Order successful!",
    product: "Product",
    quantity: "Quantity",
    size: "Size",
    deliverTo: "Deliver to",
    paymentMethod: "Payment method",
    cash: "Cash",
    transfer: "Bank transfer",
    agree: "agree",
    ok: "ok",
    yes: "yes",
    cancel: "cancel",
    no: "no",
    confirmOrder:
      "You want to buy {quantity} {product} size {size}, deliver to {address}. Say 'agree' to confirm, or 'cancel' to abort.",
    choosePayment: "Choose payment method: 'cash' or 'bank transfer'.",
    orderCanceled: "Order canceled. Please try again.",
    errorProcessing: "Error processing order. Please try again.",
    redirectingPayment: "Redirecting to VNPAY payment...",
    mute: "Mute",
    unmute: "Unmute",
    orderDetails: "Order Details",
    waitingPayment: "Waiting for payment method selection...",
  },
  // Chinese Simplified
  zh: {
    quickOrder: "Âø´ÈÄü‰∏ãÂçï",
    clickMe: "üõí Âø´ÈÄüË¥≠‰π∞ - ÁÇπÂáªÊàëÔºÅ",
    hello: "ÊÇ®Â•ΩÔºÅ‰ªäÂ§©ÊÉ≥Ë¶ÅËÆ¢Ë¥≠‰ªÄ‰πàÔºü",
    speakOrType: "ËØ¥ËØùÊàñËæìÂÖ•ÊÇ®ÁöÑËÆ¢Âçï...",
    speak: "ËØ¥ËØù",
    send: "ÂèëÈÄÅ",
    listening: "üéß Ê≠£Âú®Âê¨Âèñ...",
    parsing: "üîé Ê≠£Âú®ÂàÜÊûêËÆ¢Âçï...",
    confirming: "Ê≠£Âú®Á°ÆËÆ§ËÆ¢Âçï...",
    orderSuccess: "‚úÖ ËÆ¢ÂçïÊàêÂäüÔºÅ",
    product: "‰∫ßÂìÅ",
    quantity: "Êï∞Èáè",
    size: "Â∞∫ÂØ∏",
    deliverTo: "ÈÄÅËææ",
    paymentMethod: "ÊîØ‰ªòÊñπÂºè",
    cash: "Áé∞Èáë",
    transfer: "Èì∂Ë°åËΩ¨Ë¥¶",
    agree: "ÂêåÊÑè",
    ok: "Â•ΩÁöÑ",
    yes: "ÊòØ",
    cancel: "ÂèñÊ∂à",
    no: "‰∏ç",
    confirmOrder:
      "ÊÇ®ÊÉ≥Ë¥≠‰π∞ {quantity} ‰∏™ {product} Â∞∫ÂØ∏ {size}ÔºåÈÄÅÂà∞ {address}„ÄÇËØ¥'ÂêåÊÑè'Á°ÆËÆ§ÔºåÊàñ'ÂèñÊ∂à'‰∏≠Ê≠¢„ÄÇ",
    choosePayment: "ÈÄâÊã©ÊîØ‰ªòÊñπÂºèÔºö'Áé∞Èáë'Êàñ'Èì∂Ë°åËΩ¨Ë¥¶'„ÄÇ",
    orderCanceled: "ËÆ¢ÂçïÂ∑≤ÂèñÊ∂à„ÄÇËØ∑ÈáçËØï„ÄÇ",
    errorProcessing: "Â§ÑÁêÜËÆ¢ÂçïÊó∂Âá∫Èîô„ÄÇËØ∑ÈáçËØï„ÄÇ",
    redirectingPayment: "Ê≠£Âú®Ë∑≥ËΩ¨Âà∞VNPAYÊîØ‰ªò...",
    mute: "ÈùôÈü≥",
    unmute: "ÂèñÊ∂àÈùôÈü≥",
    orderDetails: "ËÆ¢ÂçïËØ¶ÊÉÖ",
    waitingPayment: "Á≠âÂæÖÈÄâÊã©ÊîØ‰ªòÊñπÂºè...",
  },
  // Spanish
  es: {
    quickOrder: "Pedido r√°pido",
    clickMe: "üõí Pedido r√°pido - ¬°haz clic!",
    hello: "¬°Hola! ¬øQu√© te gustar√≠a pedir hoy?",
    speakOrType: "Habla o escribe tu pedido...",
    speak: "Hablar",
    send: "Enviar",
    listening: "üéß Escuchando...",
    parsing: "üîé Analizando pedido...",
    confirming: "Confirmando pedido...",
    orderSuccess: "‚úÖ ¬°Pedido exitoso!",
    product: "Producto",
    quantity: "Cantidad",
    size: "Talla",
    deliverTo: "Entregar a",
    paymentMethod: "M√©todo de pago",
    cash: "Efectivo",
    transfer: "Transferencia",
    agree: "de acuerdo",
    ok: "ok",
    yes: "s√≠",
    cancel: "cancelar",
    no: "no",
    confirmOrder:
      "Quieres comprar {quantity} {product} talla {size}, entregar a {address}. Di 'de acuerdo' para confirmar, o 'cancelar' para abortar.",
    choosePayment: "Elige m√©todo de pago: 'efectivo' o 'transferencia'.",
    orderCanceled: "Pedido cancelado. Por favor intenta de nuevo.",
    errorProcessing: "Error procesando pedido. Por favor intenta de nuevo.",
    redirectingPayment: "Redirigiendo a pago VNPAY...",
    mute: "Silenciar",
    unmute: "Activar sonido",
    orderDetails: "Detalles del pedido",
    waitingPayment: "Esperando selecci√≥n de m√©todo de pago...",
  },
  // French
  fr: {
    quickOrder: "Commande rapide",
    clickMe: "üõí Commande rapide - cliquez-moi!",
    hello: "Bonjour! Que souhaitez-vous commander aujourd'hui?",
    speakOrType: "Parlez ou tapez votre commande...",
    speak: "Parler",
    send: "Envoyer",
    listening: "üéß √âcoute en cours...",
    parsing: "üîé Analyse de la commande...",
    confirming: "Confirmation de la commande...",
    orderSuccess: "‚úÖ Commande r√©ussie!",
    product: "Produit",
    quantity: "Quantit√©",
    size: "Taille",
    deliverTo: "Livrer √†",
    paymentMethod: "M√©thode de paiement",
    cash: "Esp√®ces",
    transfer: "Virement",
    agree: "d'accord",
    ok: "ok",
    yes: "oui",
    cancel: "annuler",
    no: "non",
    confirmOrder:
      "Vous voulez acheter {quantity} {product} taille {size}, livrer √† {address}. Dites 'd'accord' pour confirmer, ou 'annuler' pour abandonner.",
    choosePayment: "Choisissez le mode de paiement: 'esp√®ces' ou 'virement'.",
    orderCanceled: "Commande annul√©e. Veuillez r√©essayer.",
    errorProcessing:
      "Erreur lors du traitement de la commande. Veuillez r√©essayer.",
    redirectingPayment: "Redirection vers le paiement VNPAY...",
    mute: "Muet",
    unmute: "Activer le son",
    orderDetails: "D√©tails de la commande",
    waitingPayment: "En attente de s√©lection du mode de paiement...",
  },
  // German
  de: {
    quickOrder: "Schnellbestellung",
    clickMe: "üõí Schnellbestellung - klick mich!",
    hello: "Hallo! Was m√∂chten Sie heute bestellen?",
    speakOrType: "Sprechen oder tippen Sie Ihre Bestellung...",
    speak: "Sprechen",
    send: "Senden",
    listening: "üéß Zuh√∂ren...",
    parsing: "üîé Bestellung analysieren...",
    confirming: "Bestellung best√§tigen...",
    orderSuccess: "‚úÖ Bestellung erfolgreich!",
    product: "Produkt",
    quantity: "Menge",
    size: "Gr√∂√üe",
    deliverTo: "Liefern an",
    paymentMethod: "Zahlungsmethode",
    cash: "Bar",
    transfer: "√úberweisung",
    agree: "einverstanden",
    ok: "ok",
    yes: "ja",
    cancel: "abbrechen",
    no: "nein",
    confirmOrder:
      "Sie m√∂chten {quantity} {product} Gr√∂√üe {size} kaufen, liefern an {address}. Sagen Sie 'einverstanden' zum best√§tigen, oder 'abbrechen' zum abbrechen.",
    choosePayment: "W√§hlen Sie die Zahlungsmethode: 'bar' oder '√ºberweisung'.",
    orderCanceled: "Bestellung storniert. Bitte versuchen Sie es erneut.",
    errorProcessing:
      "Fehler beim Verarbeiten der Bestellung. Bitte versuchen Sie es erneut.",
    redirectingPayment: "Weiterleitung zur VNPAY-Zahlung...",
    mute: "Stumm",
    unmute: "Ton aktivieren",
    orderDetails: "Bestelldetails",
    waitingPayment: "Warten auf Auswahl der Zahlungsmethode...",
  },
  // Japanese
  ja: {
    quickOrder: "„ÇØ„Ç§„ÉÉ„ÇØÊ≥®Êñá",
    clickMe: "üõí „ÇØ„Ç§„ÉÉ„ÇØÊ≥®Êñá - „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÔºÅ",
    hello: "„Åì„Çì„Å´„Å°„ÅØÔºÅ‰ªäÊó•„ÅØ‰Ωï„ÇíÊ≥®Êñá„Åó„Åæ„Åô„ÅãÔºü",
    speakOrType: "Èü≥Â£∞ÂÖ•Âäõ„Åæ„Åü„ÅØ„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„ÅßÊ≥®Êñá...",
    speak: "Ë©±„Åô",
    send: "ÈÄÅ‰ø°",
    listening: "üéß ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô...",
    parsing: "üîé Ê≥®Êñá„ÇíÂàÜÊûê‰∏≠...",
    confirming: "Ê≥®Êñá„ÇíÁ¢∫Ë™ç‰∏≠...",
    orderSuccess: "‚úÖ Ê≥®ÊñáÊàêÂäüÔºÅ",
    product: "ÂïÜÂìÅ",
    quantity: "Êï∞Èáè",
    size: "„Çµ„Ç§„Ç∫",
    deliverTo: "ÈÖçÈÄÅÂÖà",
    paymentMethod: "ÊîØÊâï„ÅÑÊñπÊ≥ï",
    cash: "ÁèæÈáë",
    transfer: "ÈäÄË°åÊåØËæº",
    agree: "ÂêåÊÑè",
    ok: "„Ç™„Éº„Ç±„Éº",
    yes: "„ÅØ„ÅÑ",
    cancel: "„Ç≠„É£„É≥„Çª„É´",
    no: "„ÅÑ„ÅÑ„Åà",
    confirmOrder:
      "{quantity}ÂÄã„ÅÆ{product}„Çµ„Ç§„Ç∫{size}„Çí{address}„Å´ÈÖçÈÄÅ„Åó„Åæ„Åô„ÄÇÁ¢∫Ë™ç„Åô„Çã„Å´„ÅØ'ÂêåÊÑè'„ÄÅ„Ç≠„É£„É≥„Çª„É´„Åô„Çã„Å´„ÅØ'„Ç≠„É£„É≥„Çª„É´'„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
    choosePayment: "ÊîØÊâï„ÅÑÊñπÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö'ÁèæÈáë'„Åæ„Åü„ÅØ'ÈäÄË°åÊåØËæº'„ÄÇ",
    orderCanceled: "Ê≥®Êñá„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
    errorProcessing:
      "Ê≥®ÊñáÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
    redirectingPayment: "VNPAYÊ±∫Ê∏à„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà‰∏≠...",
    mute: "„Éü„É•„Éº„Éà",
    unmute: "„Éü„É•„Éº„ÉàËß£Èô§",
    orderDetails: "Ê≥®ÊñáË©≥Á¥∞",
    waitingPayment: "ÊîØÊâï„ÅÑÊñπÊ≥ï„ÅÆÈÅ∏Êäû„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...",
  },
  // Korean
  ko: {
    quickOrder: "Îπ†Î•∏ Ï£ºÎ¨∏",
    clickMe: "üõí Îπ†Î•∏ Ï£ºÎ¨∏ - ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!",
    hello: "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ïò§Îäò Î¨¥ÏóáÏùÑ Ï£ºÎ¨∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
    speakOrType: "ÏùåÏÑ± ÎòêÎäî ÌÖçÏä§Ìä∏Î°ú Ï£ºÎ¨∏ÌïòÏÑ∏Ïöî...",
    speak: "ÎßêÌïòÍ∏∞",
    send: "Ï†ÑÏÜ°",
    listening: "üéß Îì£Í≥† ÏûàÏäµÎãàÎã§...",
    parsing: "üîé Ï£ºÎ¨∏ Î∂ÑÏÑù Ï§ë...",
    confirming: "Ï£ºÎ¨∏ ÌôïÏù∏ Ï§ë...",
    orderSuccess: "‚úÖ Ï£ºÎ¨∏ ÏÑ±Í≥µ!",
    product: "ÏÉÅÌíà",
    quantity: "ÏàòÎüâ",
    size: "ÏÇ¨Ïù¥Ï¶à",
    deliverTo: "Î∞∞ÏÜ°ÏßÄ",
    paymentMethod: "Í≤∞Ï†ú Î∞©Î≤ï",
    cash: "ÌòÑÍ∏à",
    transfer: "Í≥ÑÏ¢åÏù¥Ï≤¥",
    agree: "ÎèôÏùò",
    ok: "ÌôïÏù∏",
    yes: "ÎÑ§",
    cancel: "Ï∑®ÏÜå",
    no: "ÏïÑÎãàÏò§",
    confirmOrder:
      "{quantity}Í∞úÏùò {product} ÏÇ¨Ïù¥Ï¶à {size}Î•º {address}Î°ú Î∞∞ÏÜ°Ìï©ÎãàÎã§. ÌôïÏù∏ÌïòÎ†§Î©¥ 'ÎèôÏùò', Ï∑®ÏÜåÌïòÎ†§Î©¥ 'Ï∑®ÏÜå'ÎùºÍ≥† ÎßêÌïòÏÑ∏Ïöî.",
    choosePayment: "Í≤∞Ï†ú Î∞©Î≤ïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî: 'ÌòÑÍ∏à' ÎòêÎäî 'Í≥ÑÏ¢åÏù¥Ï≤¥'.",
    orderCanceled: "Ï£ºÎ¨∏Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
    errorProcessing: "Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
    redirectingPayment: "VNPAY Í≤∞Ï†úÎ°ú Î¶¨Îã§Ïù¥Î†âÏÖò Ï§ë...",
    mute: "ÏùåÏÜåÍ±∞",
    unmute: "ÏùåÏÜåÍ±∞ Ìï¥Ï†ú",
    orderDetails: "Ï£ºÎ¨∏ ÏÉÅÏÑ∏",
    waitingPayment: "Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉùÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§...",
  },
  // Portuguese
  pt: {
    quickOrder: "Pedido r√°pido",
    clickMe: "üõí Pedido r√°pido - clique em mim!",
    hello: "Ol√°! O que gostaria de pedir hoje?",
    speakOrType: "Fale ou digite seu pedido...",
    speak: "Falar",
    send: "Enviar",
    listening: "üéß Ouvindo...",
    parsing: "üîé Analisando pedido...",
    confirming: "Confirmando pedido...",
    orderSuccess: "‚úÖ Pedido realizado com sucesso!",
    product: "Produto",
    quantity: "Quantidade",
    size: "Tamanho",
    deliverTo: "Entregar em",
    paymentMethod: "M√©todo de pagamento",
    cash: "Dinheiro",
    transfer: "Transfer√™ncia",
    agree: "concordo",
    ok: "ok",
    yes: "sim",
    cancel: "cancelar",
    no: "n√£o",
    confirmOrder:
      "Voc√™ quer comprar {quantity} {product} tamanho {size}, entregar em {address}. Diga 'concordo' para confirmar, ou 'cancelar' para abortar.",
    choosePayment:
      "Escolha o m√©todo de pagamento: 'dinheiro' ou 'transfer√™ncia'.",
    orderCanceled: "Pedido cancelado. Tente novamente.",
    errorProcessing: "Erro ao processar pedido. Tente novamente.",
    redirectingPayment: "Redirecionando para pagamento VNPAY...",
    mute: "Silenciar",
    unmute: "Ativar som",
    orderDetails: "Detalhes do pedido",
    waitingPayment: "Aguardando sele√ß√£o do m√©todo de pagamento...",
  },
  // Russian
  ru: {
    quickOrder: "–ë—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑",
    clickMe: "üõí –ë—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑ - –Ω–∞–∂–º–∏ –Ω–∞ –º–µ–Ω—è!",
    hello: "–ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
    speakOrType: "–ì–æ–≤–æ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–æ–¥–∏—Ç–µ –≤–∞—à –∑–∞–∫–∞–∑...",
    speak: "–ì–æ–≤–æ—Ä–∏—Ç—å",
    send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
    listening: "üéß –°–ª—É—à–∞—é...",
    parsing: "üîé –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–∫–∞–∑...",
    confirming: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –∑–∞–∫–∞–∑...",
    orderSuccess: "‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–µ–Ω!",
    product: "–¢–æ–≤–∞—Ä",
    quantity: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
    size: "–†–∞–∑–º–µ—Ä",
    deliverTo: "–î–æ—Å—Ç–∞–≤–∏—Ç—å –≤",
    paymentMethod: "–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã",
    cash: "–ù–∞–ª–∏—á–Ω—ã–µ",
    transfer: "–ü–µ—Ä–µ–≤–æ–¥",
    agree: "—Å–æ–≥–ª–∞—Å–µ–Ω",
    ok: "—Ö–æ—Ä–æ—à–æ",
    yes: "–¥–∞",
    cancel: "–æ—Ç–º–µ–Ω–∏—Ç—å",
    no: "–Ω–µ—Ç",
    confirmOrder:
      "–í—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å {quantity} {product} —Ä–∞–∑–º–µ—Ä {size}, –¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤ {address}. –°–∫–∞–∂–∏—Ç–µ '—Å–æ–≥–ª–∞—Å–µ–Ω' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∏–ª–∏ '–æ—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
    choosePayment: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: '–Ω–∞–ª–∏—á–Ω—ã–µ' –∏–ª–∏ '–ø–µ—Ä–µ–≤–æ–¥'.",
    orderCanceled: "–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
    errorProcessing: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
    redirectingPayment: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ–ø–ª–∞—Ç—É VNPAY...",
    mute: "–ë–µ–∑ –∑–≤—É–∫–∞",
    unmute: "–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫",
    orderDetails: "–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞",
    waitingPayment: "–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã...",
  },
  // Italian
  it: {
    quickOrder: "Ordine rapido",
    clickMe: "üõí Ordine rapido - cliccami!",
    hello: "Ciao! Cosa vorresti ordinare oggi?",
    speakOrType: "Parla o digita il tuo ordine...",
    speak: "Parla",
    send: "Invia",
    listening: "üéß Ascoltando...",
    parsing: "üîé Analizzando ordine...",
    confirming: "Confermando ordine...",
    orderSuccess: "‚úÖ Ordine riuscito!",
    product: "Prodotto",
    quantity: "Quantit√†",
    size: "Taglia",
    deliverTo: "Consegnare a",
    paymentMethod: "Metodo di pagamento",
    cash: "Contanti",
    transfer: "Bonifico",
    agree: "d'accordo",
    ok: "ok",
    yes: "s√¨",
    cancel: "annulla",
    no: "no",
    confirmOrder:
      "Vuoi comprare {quantity} {product} taglia {size}, consegnare a {address}. D√¨ 'd'accordo' per confermare, o 'annulla' per annullare.",
    choosePayment: "Scegli il metodo di pagamento: 'contanti' o 'bonifico'.",
    orderCanceled: "Ordine annullato. Riprova.",
    errorProcessing: "Errore nell'elaborazione dell'ordine. Riprova.",
    redirectingPayment: "Reindirizzamento al pagamento VNPAY...",
    mute: "Silenzia",
    unmute: "Attiva audio",
    orderDetails: "Dettagli ordine",
    waitingPayment: "In attesa della selezione del metodo di pagamento...",
  },
  // Dutch
  nl: {
    quickOrder: "Snelle bestelling",
    clickMe: "üõí Snelle bestelling - klik op mij!",
    hello: "Hallo! Wat wilt u vandaag bestellen?",
    speakOrType: "Spreek of typ uw bestelling...",
    speak: "Spreken",
    send: "Verzenden",
    listening: "üéß Luisteren...",
    parsing: "üîé Bestelling analyseren...",
    confirming: "Bestelling bevestigen...",
    orderSuccess: "‚úÖ Bestelling succesvol!",
    product: "Product",
    quantity: "Hoeveelheid",
    size: "Maat",
    deliverTo: "Bezorgen bij",
    paymentMethod: "Betaalmethode",
    cash: "Contant",
    transfer: "Overschrijving",
    agree: "akkoord",
    ok: "ok",
    yes: "ja",
    cancel: "annuleren",
    no: "nee",
    confirmOrder:
      "U wilt {quantity} {product} maat {size} kopen, bezorgen bij {address}. Zeg 'akkoord' om te bevestigen, of 'annuleren' om af te breken.",
    choosePayment: "Kies betaalmethode: 'contant' of 'overschrijving'.",
    orderCanceled: "Bestelling geannuleerd. Probeer opnieuw.",
    errorProcessing: "Fout bij verwerken bestelling. Probeer opnieuw.",
    redirectingPayment: "Doorverwijzen naar VNPAY betaling...",
    mute: "Dempen",
    unmute: "Geluid aanzetten",
    orderDetails: "Bestelgegevens",
    waitingPayment: "Wachten op selectie betaalmethode...",
  },
  // Arabic
  ar: {
    quickOrder: "ÿ∑ŸÑÿ® ÿ≥ÿ±Ÿäÿπ",
    clickMe: "üõí ÿ∑ŸÑÿ® ÿ≥ÿ±Ÿäÿπ - ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸä!",
    hello: "ŸÖÿ±ÿ≠ÿ®ÿß! ŸÖÿßÿ∞ÿß ÿ™ÿ±ŸäÿØ ÿ£ŸÜ ÿ™ÿ∑ŸÑÿ® ÿßŸÑŸäŸàŸÖÿü",
    speakOrType: "ÿ™ÿ≠ÿØÿ´ ÿ£Ÿà ÿßŸÉÿ™ÿ® ÿ∑ŸÑÿ®ŸÉ...",
    speak: "ÿ™ÿ≠ÿØÿ´",
    send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
    listening: "üéß ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ...",
    parsing: "üîé ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®...",
    confirming: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ®...",
    orderSuccess: "‚úÖ ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!",
    product: "ÿßŸÑŸÖŸÜÿ™ÿ¨",
    quantity: "ÿßŸÑŸÉŸÖŸäÿ©",
    size: "ÿßŸÑÿ≠ÿ¨ŸÖ",
    deliverTo: "ÿßŸÑÿ™ŸàÿµŸäŸÑ ÿ•ŸÑŸâ",
    paymentMethod: "ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ",
    cash: "ŸÜŸÇÿØÿßŸã",
    transfer: "ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä",
    agree: "ŸÖŸàÿßŸÅŸÇ",
    ok: "ÿ≠ÿ≥ŸÜÿßŸã",
    yes: "ŸÜÿπŸÖ",
    cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
    no: "ŸÑÿß",
    confirmOrder:
      "ÿ™ÿ±ŸäÿØ ÿ¥ÿ±ÿßÿ° {quantity} {product} ÿ≠ÿ¨ŸÖ {size}ÿå ÿßŸÑÿ™ŸàÿµŸäŸÑ ÿ•ŸÑŸâ {address}. ŸÇŸÑ 'ŸÖŸàÿßŸÅŸÇ' ŸÑŸÑÿ™ÿ£ŸÉŸäÿØÿå ÿ£Ÿà 'ÿ•ŸÑÿ∫ÿßÿ°' ŸÑŸÑÿ•ŸÑÿ∫ÿßÿ°.",
    choosePayment: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ: 'ŸÜŸÇÿØÿßŸã' ÿ£Ÿà 'ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä'.",
    orderCanceled: "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",
    errorProcessing: "ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ∑ŸÑÿ®. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",
    redirectingPayment: "ÿ•ÿπÿßÿØÿ© ÿ™Ÿàÿ¨ŸäŸá ÿ•ŸÑŸâ ÿØŸÅÿπ VNPAY...",
    mute: "ŸÉÿ™ŸÖ ÿßŸÑÿµŸàÿ™",
    unmute: "ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™",
    orderDetails: "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®",
    waitingPayment: "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ...",
  },
};

type Language = keyof typeof translations;

// Language metadata for better UI
const languageOptions = [
  { code: "vi", flag: "üáªüá≥", name: "Ti·∫øng Vi·ªát", speechLang: "vi-VN" },
  { code: "en", flag: "üá∫üá∏", name: "English", speechLang: "en-US" },
  { code: "zh", flag: "üá®üá≥", name: "‰∏≠Êñá", speechLang: "zh-CN" },
  { code: "es", flag: "üá™üá∏", name: "Espa√±ol", speechLang: "es-ES" },
  { code: "fr", flag: "üá´üá∑", name: "Fran√ßais", speechLang: "fr-FR" },
  { code: "de", flag: "üá©üá™", name: "Deutsch", speechLang: "de-DE" },
  { code: "ja", flag: "üáØüáµ", name: "Êó•Êú¨Ë™û", speechLang: "ja-JP" },
  { code: "ko", flag: "üá∞üá∑", name: "ÌïúÍµ≠Ïñ¥", speechLang: "ko-KR" },
  { code: "pt", flag: "üáßüá∑", name: "Portugu√™s", speechLang: "pt-BR" },
  { code: "ru", flag: "üá∑üá∫", name: "–†—É—Å—Å–∫–∏–π", speechLang: "ru-RU" },
  { code: "it", flag: "üáÆüáπ", name: "Italiano", speechLang: "it-IT" },
  { code: "nl", flag: "üá≥üá±", name: "Nederlands", speechLang: "nl-NL" },
  { code: "ar", flag: "üá∏üá¶", name: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©", speechLang: "ar-SA" },
];

export default function VoiceQuickOrderFlexible() {
  const [voiceText, setVoiceText] = useState<string>("");
  const [orderInfo, setOrderInfo] = useState<OrderInfo | null>(null);
  const [orderResult, setOrderResult] = useState<OrderResult | null>(null);
  const [step, setStep] = useState<Step>("idle");
  const [paymentMethod, setPaymentMethod] = useState<1 | 2 | null>(null); // Changed to null initially
  const [language, setLanguage] = useState<Language>("vi");
  const [isMuted, setIsMuted] = useState<boolean>(false);
  const recognitionRef = useRef<SpeechRecognition | null>(null);
  const [showWidget, setShowWidget] = useState<boolean>(false);
  const [aiSpeechText, setAiSpeechText] = useState<string>("");
  const [isRecording, setIsRecording] = useState<boolean>(false);
  const [pulseAnimation, setPulseAnimation] = useState<boolean>(true);

  const t = translations[language];
  const currentLangOption = languageOptions.find(
    (lang) => lang.code === language
  );

  useEffect(() => {
    if (showWidget && step === "idle") {
      speak(t.hello);
    }
  }, [showWidget, step, language]);

  // Auto pulse animation
  useEffect(() => {
    const interval = setInterval(() => {
      setPulseAnimation((prev) => !prev);
    }, 3000);
    return () => clearInterval(interval);
  }, []);

  const speak = (text: string, callback?: () => void): void => {
    if ("speechSynthesis" in window && !isMuted) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = currentLangOption?.speechLang || "vi-VN";
      setAiSpeechText(text);
      utter.onend = () => {
        setAiSpeechText("");
        if (callback) callback();
      };
      window.speechSynthesis.speak(utter);
    }
  };

  const waitForVoiceConfirm = (): Promise<"yes" | "no"> => {
    return new Promise((resolve) => {
      const SpeechRecognitionConstructor =
        window.webkitSpeechRecognition || window.SpeechRecognition;
      if (!SpeechRecognitionConstructor) {
        resolve("no");
        return;
      }

      const recognition = new SpeechRecognitionConstructor();
      recognition.lang = currentLangOption?.speechLang || "vi-VN";
      recognition.start();

      recognition.onresult = (event: SpeechRecognitionEvent) => {
        const response = event.results[0][0].transcript.toLowerCase();
        const yesWords = [t.agree, t.ok, t.yes].map((w) => w.toLowerCase());
        const noWords = [t.cancel, t.no].map((w) => w.toLowerCase());

        if (yesWords.some((word) => response.includes(word))) {
          resolve("yes");
        } else if (noWords.some((word) => response.includes(word))) {
          resolve("no");
        } else {
          resolve("no");
        }
      };

      recognition.onerror = () => resolve("no");
    });
  };

  const waitForVoicePaymentMethod = (): Promise<1 | 2> => {
    return new Promise((resolve) => {
      const SpeechRecognitionConstructor =
        window.webkitSpeechRecognition || window.SpeechRecognition;
      if (!SpeechRecognitionConstructor) {
        resolve(1);
        return;
      }

      const recognition = new SpeechRecognitionConstructor();
      recognition.lang = currentLangOption?.speechLang || "vi-VN";
      recognition.start();

      recognition.onresult = (event: SpeechRecognitionEvent) => {
        const response = event.results[0][0].transcript.toLowerCase();
        if (response.includes(t.transfer.toLowerCase())) {
          resolve(2);
        } else {
          resolve(1);
        }
      };

      recognition.onerror = () => resolve(1);
    });
  };

  const startVoice = (): void => {
    const SpeechRecognitionConstructor =
      window.webkitSpeechRecognition || window.SpeechRecognition;
    if (!SpeechRecognitionConstructor) {
      alert("Browser doesn't support voice recognition!");
      return;
    }

    setStep("listening");
    setIsRecording(true);
    const recognition = new SpeechRecognitionConstructor();
    recognition.lang = currentLangOption?.speechLang || "vi-VN";

    recognition.onresult = (event: SpeechRecognitionEvent) => {
      const text = event.results[0][0].transcript;
      setVoiceText(text);
      setIsRecording(false);
      parseOrder(text);
    };

    recognition.onerror = (event: SpeechRecognitionErrorEvent) => {
      console.error("Speech recognition error:", event.error);
      setStep("idle");
      setIsRecording(false);
    };

    recognition.start();
    recognitionRef.current = recognition;
  };

  const parseOrder = async (text: string): Promise<void> => {
    setStep("parsing");
    // Reset payment method when parsing new order
    setPaymentMethod(null);
    const token = localStorage.getItem("token");

    try {
      const res = await fetch("http://localhost:8000/api/voice-order/parse", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(token && { Authorization: `Bearer ${token}` }),
        },
        body: JSON.stringify({ text }),
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data: OrderInfo = await res.json();
      setOrderInfo(data);
      setStep("confirming");

      const confirmText = t.confirmOrder
        .replace("{quantity}", data.quantity.toString())
        .replace("{product}", data.product)
        .replace("{size}", data.size)
        .replace("{address}", data.address);

      speak(confirmText, async () => {
        const result = await waitForVoiceConfirm();
        if (result === "yes") {
          speak(t.choosePayment, async () => {
            const method = await waitForVoicePaymentMethod();
            setPaymentMethod(method);
            speak(t.confirming);
            await handleQuickOrder(data, method);
          });
        } else {
          speak(t.orderCanceled);
          setOrderInfo(null);
          setPaymentMethod(null);
          setStep("idle");
        }
      });
    } catch (error) {
      console.error("Error parsing order:", error);
      speak(t.errorProcessing);
      setStep("idle");
      setPaymentMethod(null);
    }
  };

  const handleQuickOrder = async (
    orderData: OrderInfo,
    method: 1 | 2
  ): Promise<void> => {
    const token = localStorage.getItem("token");
    const payload = {
      ...orderData,
      payment_id: method,
    };

    try {
      const res = await fetch("http://localhost:8000/api/voice-order/quick", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(token && { Authorization: `Bearer ${token}` }),
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data: OrderResult = await res.json();
      setOrderResult(data);
      setStep("done");

      if (method === 2 && data.payment_url) {
        speak(t.redirectingPayment);
        setTimeout(() => {
          window.location.href = data.payment_url!;
        }, 2000);
      } else {
        speak(data.message || t.orderSuccess);
      }
    } catch (error) {
      console.error("Error processing order:", error);
      speak(t.errorProcessing);
      setStep("idle");
      setPaymentMethod(null);
    }
  };

  const handleTextChange = (
    e: React.ChangeEvent<HTMLTextAreaElement>
  ): void => {
    setVoiceText(e.target.value);
  };

  const handleParseClick = (): void => {
    if (voiceText.trim()) {
      parseOrder(voiceText);
    }
  };

  const handleCloseWidget = (): void => {
    setShowWidget(false);
    setStep("idle");
    setVoiceText("");
    setOrderInfo(null);
    setOrderResult(null);
    setAiSpeechText("");
    setIsRecording(false);
    setPaymentMethod(null);
    if (recognitionRef.current) {
      recognitionRef.current.abort();
    }
  };

  return (
    <div className="fixed bottom-6 right-6 z-50">
      {!showWidget && (
        <div className="relative flex flex-col items-center group">
          {/* Floating message */}
          <div
            className={`mb-4 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white text-sm font-bold rounded-full shadow-xl transform transition-all duration-700 ${
              pulseAnimation ? "scale-105 shadow-2xl" : "scale-100"
            }`}
            style={{
              background: "linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42)",
              boxShadow: "0 8px 32px rgba(255, 107, 53, 0.4)",
            }}
          >
            {t.clickMe}
            <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-8 border-transparent border-t-orange-500"></div>
          </div>

          {/* Main bot button */}
          <button
            onClick={() => setShowWidget(true)}
            className={`relative rounded-full p-5 bg-gradient-to-br from-orange-500 via-red-500 to-pink-500 text-white shadow-2xl transition-all duration-500 hover:scale-110 active:scale-95 ${
              pulseAnimation ? "animate-pulse" : ""
            }`}
            style={{
              background:
                "linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42, #e94e77)",
              boxShadow: "0 12px 40px rgba(255, 107, 53, 0.5)",
            }}
          >
            <div className="absolute inset-0 rounded-full bg-white opacity-20 animate-ping"></div>
            <Bot size={28} className="relative z-10" />

            {/* Floating particles */}
            <div className="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full animate-bounce delay-75"></div>
            <div className="absolute -bottom-1 -left-1 w-2 h-2 bg-green-400 rounded-full animate-bounce delay-150"></div>
          </button>
        </div>
      )}

      {showWidget && (
        <div
          className="bg-white shadow-2xl rounded-3xl w-96 overflow-hidden transform transition-all duration-500 animate-in slide-in-from-bottom-8"
          style={{
            boxShadow: "0 25px 80px rgba(0, 0, 0, 0.15)",
            backdropFilter: "blur(20px)",
          }}
        >
          {/* Header */}
          <div className="bg-gradient-to-r from-orange-500 to-red-500 p-6 text-white relative overflow-hidden">
            <div className="absolute inset-0 bg-black opacity-10"></div>
            <div className="relative z-10 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-white bg-opacity-20 rounded-full">
                  <ShoppingBag size={20} />
                </div>
                <div>
                  <h3 className="text-lg font-bold">{t.quickOrder}</h3>
                  <p className="text-xs opacity-90">AI Assistant</p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {/* Enhanced Language selector */}
                <select
                  value={language}
                  onChange={(e) => setLanguage(e.target.value as Language)}
                  className="bg-white bg-opacity-20 text-white text-xs rounded-lg px-2 py-1 border-none outline-none cursor-pointer hover:bg-opacity-30 transition-all"
                  style={{ direction: language === "ar" ? "rtl" : "ltr" }}
                >
                  {languageOptions.map((lang) => (
                    <option
                      key={lang.code}
                      value={lang.code}
                      className="text-black"
                    >
                      {lang.flag} {lang.name}
                    </option>
                  ))}
                </select>

                {/* Mute/Unmute button */}
                <button
                  onClick={() => setIsMuted(!isMuted)}
                  className="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition-all"
                  title={isMuted ? t.unmute : t.mute}
                >
                  {isMuted ? <VolumeX size={16} /> : <Volume2 size={16} />}
                </button>

                {/* Close button */}
                <button
                  onClick={handleCloseWidget}
                  className="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition-all"
                >
                  <X size={16} />
                </button>
              </div>
            </div>

            {/* Decorative wave */}
            <div className="absolute bottom-0 left-0 right-0">
              <svg viewBox="0 0 400 20" className="w-full h-5">
                <path
                  d="M0,10 Q100,0 200,10 T400,10 L400,20 L0,20 Z"
                  fill="white"
                  opacity="0.1"
                />
              </svg>
            </div>
          </div>

          {/* Content */}
          <div
            className="p-6 space-y-4"
            style={{ direction: language === "ar" ? "rtl" : "ltr" }}
          >
            {/* Text input */}
            <div className="relative">
              <textarea
                className="w-full rounded-2xl border-2 border-gray-200 p-4 text-sm resize-none focus:border-orange-400 focus:ring-4 focus:ring-orange-100 transition-all duration-300"
                rows={3}
                placeholder={t.speakOrType}
                value={voiceText}
                onChange={handleTextChange}
                style={{ direction: language === "ar" ? "rtl" : "ltr" }}
              />
              {voiceText && (
                <div
                  className={`absolute top-2 ${
                    language === "ar" ? "left-2" : "right-2"
                  } text-orange-500`}
                >
                  <Package size={16} />
                </div>
              )}
            </div>

            {/* Action buttons */}
            <div className="flex gap-3">
              <button
                onClick={startVoice}
                disabled={isRecording}
                className={`flex-1 flex items-center justify-center gap-2 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 ${
                  isRecording
                    ? "bg-gradient-to-r from-red-500 to-pink-500 text-white animate-pulse"
                    : "bg-gradient-to-r from-orange-500 to-red-500 text-white hover:shadow-lg"
                }`}
                style={{
                  boxShadow: isRecording
                    ? "0 0 30px rgba(239, 68, 68, 0.5)"
                    : "0 8px 25px rgba(255, 107, 53, 0.3)",
                }}
              >
                <Mic
                  size={18}
                  className={isRecording ? "animate-bounce" : ""}
                />
                {isRecording ? "Recording..." : t.speak}
              </button>

              <button
                onClick={handleParseClick}
                disabled={!voiceText.trim()}
                className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-4 rounded-2xl font-semibold hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 active:scale-95"
                style={{
                  boxShadow: "0 8px 25px rgba(16, 185, 129, 0.3)",
                }}
              >
                <Send size={18} />
                {t.send}
              </button>
            </div>

            {/* Status indicator */}
            {step !== "idle" && (
              <div className="flex items-center gap-3 p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200">
                <div className="flex-shrink-0">
                  {step === "listening" && (
                    <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                  )}
                  {step === "parsing" && (
                    <div className="w-3 h-3 bg-yellow-500 rounded-full animate-spin"></div>
                  )}
                  {step === "confirming" && (
                    <div className="w-3 h-3 bg-orange-500 rounded-full animate-bounce"></div>
                  )}
                  {step === "done" && (
                    <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                  )}
                </div>
                <p className="text-sm text-gray-700 font-medium">
                  {step === "listening" && t.listening}
                  {step === "parsing" && t.parsing}
                  {step === "confirming" && t.confirming}
                  {step === "done" && t.orderSuccess}
                </p>
              </div>
            )}

            {/* Order info display */}
            {orderInfo && (
              <div className="bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl p-4 border border-orange-200 space-y-3">
                <div className="flex items-center gap-2 text-orange-600 font-semibold">
                  <ShoppingBag size={18} />
                  {t.orderDetails}
                </div>

                <div className="grid grid-cols-2 gap-3 text-sm">
                  <div className="flex items-center gap-2">
                    <Package size={14} className="text-gray-500" />
                    <span className="text-gray-600">{t.product}:</span>
                    <span className="font-semibold text-gray-800">
                      {orderInfo.product}
                    </span>
                  </div>

                  <div className="flex items-center gap-2">
                    <Clock size={14} className="text-gray-500" />
                    <span className="text-gray-600">{t.quantity}:</span>
                    <span className="font-semibold text-gray-800">
                      {orderInfo.quantity}
                    </span>
                  </div>

                  <div className="flex items-center gap-2">
                    <Package size={14} className="text-gray-500" />
                    <span className="text-gray-600">{t.size}:</span>
                    <span className="font-semibold text-gray-800">
                      {orderInfo.size}
                    </span>
                  </div>

                  <div className="flex items-center gap-2">
                    <CreditCard size={14} className="text-gray-500" />
                    <span className="text-gray-600">{t.paymentMethod}:</span>
                    <span className="font-semibold text-gray-800">
                      {paymentMethod === null ? (
                        <span className="text-orange-500 animate-pulse">
                          {t.waitingPayment}
                        </span>
                      ) : paymentMethod === 1 ? (
                        t.cash
                      ) : (
                        t.transfer
                      )}
                    </span>
                  </div>
                </div>

                <div className="flex items-start gap-2 pt-2 border-t border-orange-200">
                  <MapPin size={14} className="text-gray-500 mt-1" />
                  <div>
                    <span className="text-gray-600 text-sm">
                      {t.deliverTo}:
                    </span>
                    <p className="font-semibold text-gray-800 text-sm">
                      {orderInfo.address}
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* Order result */}
            {step === "done" && orderResult && (
              <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-4 border border-green-200">
                <div className="flex items-center gap-2 text-green-600">
                  <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                    <span className="text-white text-xs">‚úì</span>
                  </div>
                  <span className="font-semibold">{orderResult.message}</span>
                </div>
              </div>
            )}

            {/* AI Speech subtitle */}
            {aiSpeechText && (
              <div className="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-2xl p-4 border border-yellow-200 animate-pulse">
                <div className="flex items-center gap-3">
                  <div className="flex-shrink-0">
                    <div className="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-full flex items-center justify-center">
                      <Bot size={16} className="text-white" />
                    </div>
                  </div>
                  <div className="flex-1">
                    <p className="text-sm font-semibold text-yellow-800 mb-1">
                      AI Assistant
                    </p>
                    <p className="text-sm text-yellow-700">{aiSpeechText}</p>
                  </div>
                  <div className="flex space-x-1">
                    <div className="w-1 h-1 bg-yellow-500 rounded-full animate-bounce"></div>
                    <div className="w-1 h-1 bg-yellow-500 rounded-full animate-bounce delay-75"></div>
                    <div className="w-1 h-1 bg-yellow-500 rounded-full animate-bounce delay-150"></div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
